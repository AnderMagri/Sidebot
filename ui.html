<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sidebot</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Inter', -apple-system, sans-serif; 
  background: #1a1a1a; 
  color: #fff;
  overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header {
  background: #2a2a2a;
  padding: 16px;
  border-bottom: 1px solid #3a3a3a;
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4ade80;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.header-badges {
  display: flex;
  align-items: center;
  gap: 6px;
}

.beta-badge {
  background: #fbbf24;
  color: #000;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.project-title {
  font-size: 13px;
  opacity: 0.9;
  font-weight: 600;
  color: #fff;
}

.project-title.empty {
  opacity: 0.5;
  font-style: italic;
  font-size: 11px;
}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs {
  display: flex;
  background: #2a2a2a;
  border-bottom: 1px solid #3a3a3a;
}

.tab {
  flex: 1;
  padding: 10px 8px;
  font-size: 11px;
  text-align: center;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  opacity: 0.6;
}

.tab:hover { opacity: 0.9; background: #333; }
.tab.active { opacity: 1; border-bottom-color: #7B4FBE; background: #333; }

/* ‚îÄ‚îÄ‚îÄ TAB CONTENT ‚îÄ‚îÄ‚îÄ */
.tab-content {
  display: none;
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 16px;
}

.tab-content.active { display: block; }

/* ‚îÄ‚îÄ‚îÄ PROJECTS TAB ‚îÄ‚îÄ‚îÄ */
.project-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.project-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.project-item:hover {
  border-color: #7B4FBE;
  background: #333;
}

.project-item.active {
  border-color: #7B4FBE;
  background: #333;
}

.project-name {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 4px;
}

.project-stats {
  font-size: 10px;
  opacity: 0.6;
  display: flex;
  gap: 12px;
}

.project-delete {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #3a3a3a;
  border: none;
  color: #ff6b6b;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 10px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}

.project-item:hover .project-delete {
  opacity: 1;
}

.project-delete:hover {
  background: #ff6b6b;
  color: #fff;
}

.new-project-section {
  background: #2a2a2a;
  border: 2px dashed #3a3a3a;
  border-radius: 6px;
  padding: 16px;
}

.btn-add-project {
  width: 100%;
  padding: 14px;
  background: #2a2a2a;
  border: 2px dashed #7B4FBE;
  border-radius: 6px;
  color: #7B4FBE;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 12px;
}

.btn-add-project:hover {
  background: #333;
  border-color: #9b6fde;
  color: #9b6fde;
}

/* ‚îÄ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ‚îÄ */
.bottom-sheet {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  display: none;
}

.bottom-sheet.open {
  display: block;
}

.bottom-sheet-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  animation: fadeIn 0.2s;
}

.bottom-sheet-content {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 80%;
  background: #1a1a1a;
  border-radius: 12px 12px 0 0;
  animation: slideUp 0.3s;
  overflow-y: auto;
}

.sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #3a3a3a;
  position: sticky;
  top: 0;
  background: #1a1a1a;
  z-index: 1;
}

.sheet-title {
  font-size: 14px;
  font-weight: 600;
}

.sheet-close {
  background: #2a2a2a;
  border: none;
  color: #fff;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.sheet-close:hover {
  background: #3a3a3a;
}

.sheet-body {
  padding: 16px;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.new-project-section input {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 12px;
  margin-bottom: 8px;
}

.btn-primary {
  width: 100%;
  padding: 10px;
  background: #7B4FBE;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary:hover {
  background: #6a3fa8;
}

.btn-success {
  width: 100%;
  padding: 10px;
  background: #4ade80;
  color: #000;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-success:hover {
  background: #3ac970;
}

.btn-secondary {
  padding: 10px;
  background: #2a2a2a;
  border: 1px solid #7B4FBE;
  color: #fff;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  background: #7B4FBE;
  border-color: #7B4FBE;
}

.send-claude-section {
  margin-bottom: 16px;
  padding: 12px;
  background: #2a2a2a;
  border-radius: 6px;
  border: 1px solid #3a3a3a;
}

.import-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #3a3a3a;
}

.section-title {
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.section-desc {
  font-size: 10px;
  opacity: 0.6;
  margin-bottom: 8px;
  line-height: 1.4;
}

textarea {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 10px;
  font-family: monospace;
  resize: vertical;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ‚îÄ GOALS TAB ‚îÄ‚îÄ‚îÄ */
.goals-header {
  text-align: center;
  margin-bottom: 20px;
}

.goals-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
}

.goals-progress {
  font-size: 11px;
  opacity: 0.7;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #2a2a2a;
  border-radius: 3px;
  overflow: hidden;
  margin-top: 8px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #7B4FBE, #9b6fde);
  transition: width 0.3s;
}

.goal-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.goal-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.goal-item:hover {
  background: #333;
}

.goal-checkbox {
  width: 18px;
  height: 18px;
  border: 2px solid #3a3a3a;
  border-radius: 4px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  margin-top: 2px;
}

.goal-item.done .goal-checkbox {
  background: #7B4FBE;
  border-color: #7B4FBE;
}

.goal-item.done .goal-checkbox::after {
  content: '‚úì';
  color: #fff;
  font-size: 12px;
  font-weight: 700;
}

.goal-text {
  flex: 1;
  font-size: 12px;
  line-height: 1.5;
}

.goal-item.done .goal-text {
  opacity: 0.5;
  text-decoration: line-through;
}

/* ‚îÄ‚îÄ‚îÄ FIXES TAB ‚îÄ‚îÄ‚îÄ */
.fix-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.fix-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-left: 3px solid #ff6b6b;
  border-radius: 6px;
  padding: 12px;
}

.fix-item.done {
  border-left-color: #4ade80;
  opacity: 0.6;
}

.fix-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.fix-title {
  font-size: 12px;
  font-weight: 600;
  color: #ff6b6b;
}

.fix-item.done .fix-title {
  color: #4ade80;
}

.fix-description {
  font-size: 11px;
  line-height: 1.5;
  margin-bottom: 10px;
  opacity: 0.8;
}

.fix-actions {
  display: flex;
  gap: 6px;
}

.fix-btn {
  flex: 1;
  padding: 6px 10px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.fix-btn.done-btn {
  background: #4ade80;
  color: #000;
}

.fix-btn.done-btn:hover {
  background: #3ac970;
}

.fix-btn.done-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  opacity: 0.5;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.empty-text {
  font-size: 12px;
  line-height: 1.6;
}

/* ‚îÄ‚îÄ‚îÄ SETTINGS TAB ‚îÄ‚îÄ‚îÄ */
.settings-section {
  margin-bottom: 24px;
}

.settings-header {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.settings-description {
  font-size: 10px;
  opacity: 0.6;
  margin-bottom: 12px;
  line-height: 1.5;
}

.status-connected {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: #1a3d1a;
  border: 1px solid #2a5a2a;
  border-radius: 4px;
  font-size: 11px;
}

.status-card {
  padding: 12px;
  border-radius: 6px;
  font-size: 11px;
  line-height: 1.6;
  margin-bottom: 12px;
}

.status-card.connected {
  background: #1a3d1a;
  border: 1px solid #2a5a2a;
  color: #4ade80;
}

.status-card.disconnected {
  background: #3d1a1a;
  border: 1px solid #5a2a2a;
  color: #ff6b6b;
}

.btn-download {
  display: block;
  width: 100%;
  padding: 12px;
  background: #7B4FBE;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  text-decoration: none;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 12px;
  transition: all 0.2s;
}

.btn-download:hover {
  background: #6a3fa8;
  transform: translateY(-1px);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4ade80;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.help-text {
  font-size: 10px;
  opacity: 0.5;
  line-height: 1.5;
  margin-top: 8px;
}

.keyboard-shortcuts {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px;
  font-size: 10px;
  padding: 12px;
  background: #2a2a2a;
  border-radius: 4px;
}

.key {
  background: #1a1a1a;
  padding: 4px 8px;
  border-radius: 3px;
  font-weight: 600;
  text-align: center;
  min-width: 24px;
}

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
.tab-content::-webkit-scrollbar {
  width: 6px;
}

.tab-content::-webkit-scrollbar-track {
  background: #1a1a1a;
}

.tab-content::-webkit-scrollbar-thumb {
  background: #3a3a3a;
  border-radius: 3px;
}

.tab-content::-webkit-scrollbar-thumb:hover {
  background: #4a4a4a;
}

/* ‚îÄ‚îÄ‚îÄ FIXES ACTION BUTTONS ‚îÄ‚îÄ‚îÄ */
.fixes-actions-section {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 16px;
  margin-bottom: 16px;
}

.action-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 14px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.action-btn:hover {
  background: #333;
  border-color: #7B4FBE;
  transform: translateY(-1px);
}

.action-btn-primary {
  grid-column: 1 / -1;
  background: #7B4FBE;
  border-color: #7B4FBE;
}

.action-btn-primary:hover {
  background: #6a3fa8;
}

.action-icon {
  font-size: 16px;
}

.action-label {
  flex: 1;
}

/* ‚îÄ‚îÄ‚îÄ CONFETTI ANIMATION ‚îÄ‚îÄ‚îÄ */
@keyframes confetti-fall {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg);
    opacity: 0;
  }
}

.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 9999;
  pointer-events: none;
}

.confetti-purple { background: #7B4FBE; }
.confetti-yellow { background: #fbbf24; }
.confetti-blue { background: #3b82f6; }
.confetti-green { background: #10b981; }
.confetti-pink { background: #ec4899; }

/* ‚îÄ‚îÄ‚îÄ ARCHITECTURE DIAGRAM ‚îÄ‚îÄ‚îÄ */
.arch-flow {
  display: flex;
  align-items: center;
  gap: 4px;
  margin: 10px 0;
}
.arch-node {
  flex: 1;
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 8px 4px;
  text-align: center;
}
.arch-node.highlight { border-color: #7B4FBE; }
.arch-node-icon { font-size: 16px; margin-bottom: 2px; }
.arch-node-name { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
.arch-node-sub { font-size: 8px; opacity: 0.45; margin-top: 1px; }
.arch-arrow { font-size: 13px; opacity: 0.35; flex-shrink: 0; }
.arch-mcp-row {
  background: #222;
  border: 1px dashed #444;
  border-radius: 4px;
  padding: 6px 10px;
  font-size: 9px;
  opacity: 0.65;
  text-align: center;
  margin-top: 4px;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ‚îÄ LED STATUS PANEL ‚îÄ‚îÄ‚îÄ */
.led-panel {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.led-row {
  display: flex;
  align-items: center;
  gap: 10px;
}
.led {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.led.green {
  background: #4ade80;
  box-shadow: 0 0 7px #4ade8088;
  animation: led-pulse 2s infinite;
}
.led.red {
  background: #ff6b6b;
  box-shadow: 0 0 7px #ff6b6b88;
}
.led.amber {
  background: #fbbf24;
  box-shadow: 0 0 7px #fbbf2466;
}
.led.gray { background: #555; }
@keyframes led-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.55; }
}
.led-info { flex: 1; }
.led-name { font-size: 11px; font-weight: 600; }
.led-status { font-size: 10px; opacity: 0.55; margin-top: 1px; }

.btn-refresh {
  background: none;
  border: 1px solid #3a3a3a;
  color: #7B4FBE;
  font-size: 10px;
  cursor: pointer;
  padding: 3px 8px;
  border-radius: 4px;
  transition: all 0.15s;
}
.btn-refresh:hover { background: #3a3a3a; }

/* ‚îÄ‚îÄ‚îÄ TROUBLESHOOTING CHAT ‚îÄ‚îÄ‚îÄ */
.chat-widget {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  overflow: hidden;
}
.chat-messages {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
}
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
.chat-msg {
  max-width: 88%;
  padding: 8px 10px;
  border-radius: 8px;
  font-size: 11px;
  line-height: 1.55;
  white-space: pre-wrap;
}
.chat-msg.bot {
  background: #383838;
  align-self: flex-start;
  border-bottom-left-radius: 2px;
}
.chat-msg.user {
  background: #7B4FBE;
  align-self: flex-end;
  border-bottom-right-radius: 2px;
}
.chat-options {
  border-top: 1px solid #3a3a3a;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.chat-opt-btn {
  width: 100%;
  padding: 7px 10px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #ccc;
  font-size: 10px;
  text-align: left;
  cursor: pointer;
  transition: all 0.15s;
}
.chat-opt-btn:hover { background: #333; border-color: #7B4FBE; color: #fff; }

/* ‚îÄ‚îÄ‚îÄ ADD PROJECT AREA (dynamic) ‚îÄ‚îÄ‚îÄ */
.add-project-claude-block {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.btn-ask-claude {
  width: 100%;
  padding: 12px 14px;
  background: #7B4FBE;
  border: none;
  border-radius: 6px;
  color: #fff;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-ask-claude:hover { background: #6a3fa8; transform: translateY(-1px); }
.ask-claude-label { font-size: 10px; opacity: 0.75; margin-bottom: 4px; }
.ask-claude-prompt {
  font-size: 11px;
  font-family: monospace;
  background: rgba(0,0,0,0.25);
  padding: 4px 8px;
  border-radius: 3px;
  letter-spacing: 0.2px;
}
.ask-claude-copy-hint { font-size: 9px; opacity: 0.45; margin-top: 5px; }
.btn-add-manual {
  width: 100%;
  padding: 9px;
  background: none;
  border: 1px dashed #3a3a3a;
  border-radius: 6px;
  color: #666;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-add-manual:hover { border-color: #555; color: #aaa; background: #2a2a2a; }
.btn-ask-claude-ghost {
  width: 100%;
  padding: 9px;
  background: none;
  border: 1px dashed #3a3a3a;
  border-radius: 6px;
  color: #555;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}
.btn-ask-claude-ghost:hover { border-color: #7B4FBE55; color: #888; }
.bridge-nudge {
  font-size: 10px;
  color: #fbbf24;
  text-align: center;
  padding: 5px 0 2px;
  animation: fadeIn 0.2s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ‚îÄ‚îÄ‚îÄ FIXES TAB: CONVERSATION LAYOUT ‚îÄ‚îÄ‚îÄ */
#fixes-content { display: none; }
#fixes-content.active {
  display: flex !important;
  flex-direction: column;
  overflow: hidden;
  padding: 0;
}
.results-area {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.results-area::-webkit-scrollbar { width: 4px; }
.results-area::-webkit-scrollbar-track { background: #1a1a1a; }
.results-area::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 2px; }

/* Quick Actions bottom bar */
.quick-actions-bar {
  flex-shrink: 0;
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  background: #222;
  border-top: 1px solid #3a3a3a;
}
.qa-bar-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 8px 10px;
  background: #7B4FBE;
  border: none;
  border-radius: 6px;
  color: #fff;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.qa-bar-btn:hover { background: #6a3fa8; }
.qa-clear-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  animation: fadeIn 0.15s ease;
}
.qa-clear-btn:hover { border-color: #ff6b6b; background: #3d1a1a; }
.qa-cancel-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 10px 14px;
  background: #3d1a1a;
  border: 1px solid #ff6b6b44;
  border-radius: 6px;
  color: #ff6b6b;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  animation: fadeIn 0.15s ease;
}
.qa-cancel-btn:hover { background: #5a2a2a; border-color: #ff6b6b88; }

/* Result item error variant */
.result-item.error { border-left: 3px solid #ff6b6b; }

/* Action tiles grid in bottom sheet */
.action-tiles-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 4px;
}
.action-tile {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.action-tile:hover { border-color: #7B4FBE; background: #333; transform: translateY(-1px); }
.action-tile:active { transform: translateY(0); }
.action-tile-icon { font-size: 20px; flex-shrink: 0; }
.action-tile-name { font-size: 11px; font-weight: 600; }
.action-tile-desc { font-size: 9px; opacity: 0.45; margin-top: 2px; }

/* Rename section ‚Äî below the action grid */
.rename-section {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #2e2e2e;
}
.rename-section-title {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  opacity: 0.35;
  margin-bottom: 8px;
}
.rename-btns-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.rename-inline-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 10px;
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  color: #fff;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s;
}
.rename-inline-btn:hover { border-color: #7B4FBE55; background: #333; }
.rename-btn-icon { font-size: 15px; flex-shrink: 0; }
.rename-btn-name { font-size: 10px; font-weight: 600; margin-bottom: 1px; }
.rename-btn-desc { font-size: 8px; opacity: 0.4; }

/* Selection badge on the Actions button */
.qa-sel-badge {
  background: rgba(255,255,255,0.18);
  border-radius: 8px;
  padding: 1px 5px;
  font-size: 9px;
  font-weight: 700;
  margin-left: 5px;
  vertical-align: middle;
}

/* Conversation result items */
.result-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  padding: 12px;
  animation: slideInUp 0.25s ease;
}
.result-item.grammar  { border-left: 3px solid #fbbf24; }
.result-item.autolayout { border-left: 3px solid #3b82f6; }
.result-item.alignment  { border-left: 3px solid #8b5cf6; }
.result-item.contrast   { border-left: 3px solid #f97316; }
.result-item.applied { opacity: 0.45; }
@keyframes slideInUp {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.result-action-badge {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0.5;
  margin-bottom: 4px;
}
.result-node-name { font-size: 10px; opacity: 0.45; margin-bottom: 8px; }
.result-text-diff {
  background: #1a1a1a;
  border-radius: 4px;
  padding: 8px 10px;
  margin-bottom: 10px;
  font-size: 11px;
  line-height: 1.6;
}
.diff-original  { color: #ff6b6b; text-decoration: line-through; opacity: 0.8; margin-bottom: 3px; }
.diff-corrected { color: #4ade80; }
.result-description { font-size: 11px; line-height: 1.5; opacity: 0.8; margin-bottom: 10px; }
.result-actions-row { display: flex; gap: 6px; justify-content: flex-end; }
.result-btn {
  padding: 5px 12px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  border: none;
}
.result-btn.apply    { background: #4ade80; color: #000; }
.result-btn.apply:hover    { background: #3ac970; }
.result-btn.apply:disabled { opacity: 0.4; cursor: default; }
.result-btn.annotate { background: #3b82f6; color: #fff; }
.result-btn.annotate:hover { background: #2563eb; }
.result-btn.annotate:disabled { opacity: 0.4; cursor: default; }

/* Analyzing indicator */
.analyzing-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  font-size: 11px;
  opacity: 0.7;
}
.analyzing-dots { display: flex; gap: 4px; }
.analyzing-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #7B4FBE;
  animation: dotBounce 1.2s infinite;
}
.analyzing-dot:nth-child(2) { animation-delay: 0.2s; }
.analyzing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes dotBounce {
  0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
  40%           { transform: scale(1);   opacity: 1; }
}

/* Results section separator */
.results-section-header {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  opacity: 0.35;
  padding: 2px 0;
}

/* Rename bottom sheet */
.rename-options { display: flex; flex-direction: column; gap: 8px; }
.rename-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}
.rename-option:hover { border-color: #7B4FBE; background: #333; }
.rename-option-icon { font-size: 20px; flex-shrink: 0; }
.rename-option-title { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
.rename-option-desc  { font-size: 10px; opacity: 0.45; }

</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <div class="connection-status">
      <div class="status-dot"></div>
      <span>Claude</span>
    </div>
    <div class="header-badges">
      <div class="beta-badge">BETA</div>
      <div class="beta-badge">v1.0</div>
    </div>
  </div>
  <div class="project-title empty" id="headerProject">No project selected</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="projects">üìÅ Projects</div>
  <div class="tab" data-tab="fixes">üîß Fixes</div>
  <div class="tab" data-tab="goals">üéØ Goals</div>
  <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
</div>

<!-- Projects Tab -->
<div class="tab-content active" id="projects-content">
  <div class="project-list" id="projectList"></div>
  <div id="addProjectArea"></div>
</div>

<!-- Add Project Bottom Sheet -->
<div class="bottom-sheet" id="addProjectSheet">
  <div class="bottom-sheet-overlay" onclick="closeAddProject()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">üìã Add New Project</div>
      <button class="sheet-close" onclick="closeAddProject()">‚úï</button>
    </div>
    
    <div class="sheet-body">
      <div class="section-desc">
        1. Copy this prompt and paste in Claude Desktop with your PRD:
      </div>
      <textarea id="promptTemplate" readonly rows="3" onclick="copyPrompt()" style="margin-bottom: 12px; opacity: 0.8; cursor: pointer; background: #2a2a2a; font-size: 10px;">Analyze this PRD and create JSON for Sidebot:

[Paste your PRD here]

Return format: {"projectName": "...", "goals": ["...", "..."]}</textarea>
      
      <div class="section-desc" style="margin-top: 12px;">
        2. Paste Claude's JSON response here:
      </div>
      <textarea id="jsonInput" rows="4" placeholder='{"projectName": "My Project", "goals": ["Goal 1", "Goal 2"]}' style="font-size: 11px;"></textarea>
      <button class="btn-success" onclick="importJSON()">‚ú® Import Project + Goals</button>
    </div>
  </div>
</div>

<!-- Goals Tab -->
<div class="tab-content" id="goals-content">
  <div class="goals-header">
    <div class="goals-title" id="goalsTitle">No project selected</div>
    <div class="goals-progress">
      <span id="goalsProgress">0/0 complete (0%)</span>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
  </div>
  
  <div class="send-claude-section">
    <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; opacity: 0.7;">üì§ Send to Claude for Review</div>
    <div style="display: flex; gap: 8px;">
      <button class="btn-secondary" onclick="sendToClaude('selection')" style="flex: 1;">
        üìç Selection
      </button>
      <button class="btn-secondary" onclick="sendToClaude('page')" style="flex: 1;">
        üìÑ Current Page
      </button>
    </div>
  </div>
  
  <div class="goal-list" id="goalList"></div>
  
  <div class="empty-state" id="goalsEmpty">
    <div class="empty-icon">üéØ</div>
    <div class="empty-text">
      No goals yet.<br>
      Add a project with goals to track progress.
    </div>
  </div>
</div>

<!-- Fixes Tab -->
<div class="tab-content" id="fixes-content">
  <!-- Scrollable conversation area -->
  <div class="results-area" id="resultsArea">
    <div class="empty-state" id="fixesEmpty">
      <div class="empty-icon">‚ú®</div>
      <div class="empty-text">
        Select a frame in Figma,<br>then tap Actions below.
      </div>
    </div>
  </div>
  <!-- Fixed bottom bar -->
  <div class="quick-actions-bar" id="quickActionsBar">
    <button class="qa-bar-btn" id="qaMainBtn" onclick="openQuickActions()">‚ö° Actions<span class="qa-sel-badge" id="qaSelBadge" style="display:none;"></span></button>
    <button class="qa-cancel-btn" id="qaCancelBtn" onclick="cancelAction()" style="display:none;">‚úï Cancel</button>
    <button class="qa-clear-btn" id="qaClearBtn" onclick="clearResults()" title="Clear results" style="display:none;">üóëÔ∏è</button>
  </div>
</div>

<!-- Actions Bottom Sheet -->
<div class="bottom-sheet" id="quickActionsSheet">
  <div class="bottom-sheet-overlay" onclick="closeQuickActions()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">‚ö° Actions</div>
      <button class="sheet-close" onclick="closeQuickActions()">‚úï</button>
    </div>
    <div class="sheet-body">
      <div class="section-desc" id="actionsSheetDesc" style="margin-bottom: 12px;">Select one or more frames, then choose an action.</div>
      <div class="action-tiles-grid">
        <div class="action-tile" onclick="runAction('grammar')">
          <div class="action-tile-icon">üî§</div>
          <div><div class="action-tile-name">Grammar</div><div class="action-tile-desc">Fix text errors</div></div>
        </div>
        <div class="action-tile" onclick="runAction('autolayout')">
          <div class="action-tile-icon">üìê</div>
          <div><div class="action-tile-name">Auto-layout</div><div class="action-tile-desc">Spacing & padding</div></div>
        </div>
        <div class="action-tile" onclick="runAction('alignment')">
          <div class="action-tile-icon">üìè</div>
          <div><div class="action-tile-name">Alignment</div><div class="action-tile-desc">Element alignment</div></div>
        </div>
        <div class="action-tile" onclick="runAction('contrast')">
          <div class="action-tile-icon">üé®</div>
          <div><div class="action-tile-name">Contrast</div><div class="action-tile-desc">Color accessibility</div></div>
        </div>
      </div>

      <!-- Rename Layers section -->
      <div class="rename-section">
        <div class="rename-section-title">‚úèÔ∏è Rename Layers</div>
        <div class="rename-btns-row">
          <button class="rename-inline-btn" onclick="closeQuickActions(); renameAction('native');">
            <span class="rename-btn-icon">‚åò</span>
            <div>
              <div class="rename-btn-name">Rename (Native)</div>
              <div class="rename-btn-desc">Figma's rename dialog</div>
            </div>
          </button>
          <button class="rename-inline-btn" onclick="closeQuickActions(); renameAction('from-content');">
            <span class="rename-btn-icon">üìù</span>
            <div>
              <div class="rename-btn-name">Rename (Content)</div>
              <div class="rename-btn-desc">Name from text content</div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Rename Layers Bottom Sheet -->
<div class="bottom-sheet" id="renameSheet">
  <div class="bottom-sheet-overlay" onclick="closeRenameSheet()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">‚úèÔ∏è Rename Layers</div>
      <button class="sheet-close" onclick="closeRenameSheet()">‚úï</button>
    </div>
    <div class="sheet-body">
      <!-- Native Figma shortcut -->
      <div class="rename-option" onclick="renameAction('native')" style="background:#1a1a1a; border-color:#7B4FBE33; margin-bottom:12px;">
        <div class="rename-option-icon">‚ú®</div>
        <div style="flex:1;">
          <div class="rename-option-title">Figma native rename</div>
          <div class="rename-option-desc">Batch rename ¬∑ search & replace ¬∑ prefix/suffix ¬∑ numbering</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;align-items:flex-end;flex-shrink:0;">
          <span style="background:#2a2a2a;border:1px solid #444;border-radius:4px;padding:2px 7px;font-size:10px;font-weight:700;font-family:monospace;">‚åòR</span>
          <span style="font-size:9px;opacity:0.35;">Ctrl+R on Win</span>
        </div>
      </div>

      <div class="section-desc" style="margin-bottom:8px;padding-top:4px;border-top:1px solid #2a2a2a;">Our extras ‚Äî selects layers first</div>
      <div class="rename-options">
        <div class="rename-option" onclick="renameAction('from-content')">
          <div class="rename-option-icon">üìù</div>
          <div>
            <div class="rename-option-title">Name from content</div>
            <div class="rename-option-desc">Text layers get named after their actual text</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div class="tab-content" id="settings-content">

  <!-- How it works -->
  <div class="settings-section">
    <div class="settings-header">üìê How Sidebot Works</div>
    <div class="arch-flow">
      <div class="arch-node highlight">
        <div class="arch-node-icon">üß©</div>
        <div class="arch-node-name">Plugin</div>
        <div class="arch-node-sub">This panel</div>
      </div>
      <div class="arch-arrow">‚ü∑</div>
      <div class="arch-node">
        <div class="arch-node-icon">üåâ</div>
        <div class="arch-node-name">Bridge</div>
        <div class="arch-node-sub">localhost:3001</div>
      </div>
      <div class="arch-arrow">‚ü∑</div>
      <div class="arch-node">
        <div class="arch-node-icon">ü§ñ</div>
        <div class="arch-node-name">Claude</div>
        <div class="arch-node-sub">Desktop app</div>
      </div>
    </div>
    <div class="arch-mcp-row">
      ‚ú¶ Figma Connector (MCP) ‚Äî Claude reads Figma files directly via API
    </div>
    <div class="settings-description" style="margin-top: 8px;">
      Figma plugins are sandboxed ‚Äî they can't call Claude directly. The <strong>Bridge</strong> is a small local server that relays messages between them. The <strong>Figma Connector</strong> is a separate MCP tool that lets Claude read your design files without any copy/paste.
    </div>
  </div>

  <!-- Live Status LEDs -->
  <div class="settings-section">
    <div class="settings-header" style="display: flex; justify-content: space-between; align-items: center;">
      <span>üí° Live Status</span>
      <button class="btn-refresh" onclick="refreshStatus()">‚Üª Refresh</button>
    </div>
    <div class="led-panel">
      <div class="led-row">
        <div class="led green"></div>
        <div class="led-info">
          <div class="led-name">Plugin</div>
          <div class="led-status">Running inside Figma</div>
        </div>
      </div>
      <div class="led-row">
        <div class="led gray" id="bridgeLed"></div>
        <div class="led-info">
          <div class="led-name">Bridge Server</div>
          <div class="led-status" id="bridgeLedStatus">Checking‚Ä¶</div>
        </div>
      </div>
      <div class="led-row">
        <div class="led amber"></div>
        <div class="led-info">
          <div class="led-name">Figma Connector (MCP)</div>
          <div class="led-status">Verify in Claude Desktop ‚Üí Settings ‚Üí Connectors</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bridge download (shown only when offline) -->
  <div class="settings-section" id="bridgeSetupSection" style="display:none;">
    <div class="settings-header">‚ö° Start the Bridge</div>
    <div class="settings-description">
      The Bridge is a small local server you run once. It stays in the background and reconnects automatically.
    </div>
    <a href="https://github.com/AnderMagri/sidebot/tree/main/bridge" target="_blank" class="btn-download">
      üì• Download Bridge
    </a>
    <div class="help-text">
      <strong>Setup (2 min):</strong><br>
      1. Download from GitHub<br>
      2. Run <code>start.sh</code> (Mac/Linux) or <code>start.bat</code> (Windows)<br>
      3. Come back and hit ‚Üª Refresh
    </div>
  </div>

  <!-- Troubleshooting Chat -->
  <div class="settings-section">
    <div class="settings-header" style="display:flex;justify-content:space-between;align-items:center;">
      <span>üí¨ Troubleshoot</span>
      <button class="btn-refresh" onclick="restartChat()">‚Ü∫ Restart</button>
    </div>
    <div class="chat-widget">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-options" id="chatOptions"></div>
    </div>
  </div>

  <!-- Keyboard Shortcuts -->
  <div class="settings-section">
    <div class="settings-header">‚å®Ô∏è Keyboard Shortcuts</div>
    <div class="keyboard-shortcuts">
      <span class="key">1</span> <span>Projects</span>
      <span class="key">2</span> <span>Fixes</span>
      <span class="key">3</span> <span>Goals</span>
      <span class="key">4</span> <span>Settings</span>
    </div>
  </div>

  <!-- About -->
  <div class="settings-section">
    <div class="settings-header">‚ÑπÔ∏è About</div>
    <div class="help-text">
      <strong>Sidebot v1.0</strong><br>
      AI-powered PRD validation for Figma<br><br>
      Track requirements, get instant feedback, and catch issues early with Claude Desktop integration.<br><br>
      <strong>Support:</strong> GitHub Issues &nbsp;|&nbsp; <strong>License:</strong> MIT
    </div>
  </div>

</div>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PRODUCT COPILOT v1.0 - UI with Bridge Connection
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  let currentProject = null;
  let allProjects = [];
  let bridgeSocket = null;
  let bridgeConnected = false;
  
  // ‚îÄ‚îÄ‚îÄ CONNECT TO BRIDGE SERVER ‚îÄ‚îÄ‚îÄ
  function connectToBridge() {
    try {
      bridgeSocket = new WebSocket('ws://localhost:3001');
      
      bridgeSocket.onopen = () => {
        console.log('üü¢ Connected to bridge server');
        bridgeConnected = true;
        updateConnectionIndicator(true);
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'connect-to-bridge',
            connected: true
          } 
        }, '*');
        
        // Send current state
        sendStateToBridge();
      };
      
      bridgeSocket.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          console.log('üì® From bridge:', message.type);
          
          handleBridgeMessage(message);
        } catch (e) {
          console.error('Error parsing bridge message:', e);
        }
      };
      
      bridgeSocket.onclose = () => {
        console.log('üî¥ Bridge disconnected');
        bridgeConnected = false;
        updateConnectionIndicator(false);
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'connect-to-bridge',
            connected: false
          } 
        }, '*');
        
        // Attempt reconnect after 3 seconds
        setTimeout(connectToBridge, 3000);
      };
      
      bridgeSocket.onerror = (error) => {
        console.error('Bridge connection error:', error);
      };
      
    } catch (e) {
      console.error('Failed to connect to bridge:', e);
      setTimeout(connectToBridge, 3000);
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ HANDLE MESSAGES FROM BRIDGE ‚îÄ‚îÄ‚îÄ
  function handleBridgeMessage(message) {
    if (message.type === 'connection-established') {
      console.log('‚úÖ Bridge confirmed connection');
    }
    
    if (message.type === 'add-goals-from-claude') {
      // Claude is adding goals via bridge!
      const existing = allProjects.find(p => p.name === message.projectName);
      
      if (existing) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'add-goals',
            projectId: existing.id,
            goals: message.goals,
            prdText: message.prdText || ''
          } 
        }, '*');
      } else {
        // Create new project
        parent.postMessage({ 
          pluginMessage: { 
            type: 'create-project',
            name: message.projectName
          } 
        }, '*');
        
        window.pendingGoals = {
          goals: message.goals,
          prdText: message.prdText || ''
        };
      }
      
      // Show notification
      alert(`‚úÖ Claude added ${message.goals.length} goals to "${message.projectName}"!`);
    }
    
    if (message.type === 'add-fixes-from-claude') {
      // Switch to Fixes tab and show results as conversation items
      document.querySelector('[data-tab="fixes"]').click();
      removeAnalyzingIndicator();

      const fixes = message.fixes || [];
      fixes.forEach((fix, i) => {
        setTimeout(() => {
          addResultItem({
            id: 'bridge-' + Date.now() + '-' + i,
            action: fix.action || window.pendingActionType || 'grammar',
            nodeId: fix.nodeId || '',
            nodeName: fix.nodeName || '',
            original: fix.current || fix.original || '',
            corrected: fix.expected || fix.corrected || fix.suggestion || '',
            description: fix.description || fix.suggestion || fix.issue || '',
            issue: fix.issue || ''
          });
        }, i * 120);
      });

      // Also persist to project if active
      const existing = allProjects.find(p => p.name === message.projectName);
      if (existing) {
        parent.postMessage({ pluginMessage: { type: 'add-fixes', projectId: existing.id, fixes } }, '*');
      }
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ SEND STATE TO BRIDGE ‚îÄ‚îÄ‚îÄ
  function sendStateToBridge() {
    if (!bridgeSocket || bridgeSocket.readyState !== WebSocket.OPEN) return;
    
    bridgeSocket.send(JSON.stringify({
      type: 'state-update',
      projects: allProjects,
      activeProject: currentProject
    }));
  }
  
  // ‚îÄ‚îÄ‚îÄ UPDATE CONNECTION INDICATOR ‚îÄ‚îÄ‚îÄ
  function updateConnectionIndicator(connected) {
    const dot = document.querySelector('.status-dot');
    const text = document.querySelector('.connection-status span');

    if (connected) {
      dot.style.background = '#4ade80';
      text.textContent = 'Claude';
    } else {
      dot.style.background = '#ff6b6b';
      text.textContent = 'Offline';
    }

    updateLedPanel(connected);
  }

  // ‚îÄ‚îÄ‚îÄ UPDATE LED PANEL ‚îÄ‚îÄ‚îÄ
  function updateLedPanel(connected) {
    const led = document.getElementById('bridgeLed');
    const status = document.getElementById('bridgeLedStatus');
    const setupSection = document.getElementById('bridgeSetupSection');

    if (connected) {
      led.className = 'led green';
      status.textContent = 'Connected on localhost:3001';
      setupSection.style.display = 'none';
    } else {
      led.className = 'led red';
      status.textContent = 'Not running ‚Äî start the Bridge server';
      setupSection.style.display = 'block';
    }

    updateAddProjectArea(connected);
  }

  // ‚îÄ‚îÄ‚îÄ ADD PROJECT AREA ‚îÄ‚îÄ‚îÄ
  function updateAddProjectArea(connected) {
    const area = document.getElementById('addProjectArea');
    if (!area) return;

    if (connected) {
      area.innerHTML =
        '<div class="add-project-claude-block">' +
          '<button class="btn-ask-claude" onclick="copyClaudeProjectPrompt(this)">' +
            '<div class="ask-claude-label">üí¨ Ask Claude to create it</div>' +
            '<div class="ask-claude-prompt">"Create a project called [name]"</div>' +
            '<div class="ask-claude-copy-hint">Click to copy prompt</div>' +
          '</button>' +
          '<button class="btn-add-manual" onclick="openAddProject()">or add manually</button>' +
        '</div>';
    } else {
      area.innerHTML =
        '<div class="add-project-claude-block">' +
          '<button class="btn-add-project" onclick="openAddProject()">+ Add New Project</button>' +
          '<button class="btn-ask-claude-ghost" onclick="showBridgeNudge(this)">üí¨ or ask Claude to create it<span style="display:block;font-size:9px;opacity:0.45;margin-top:3px;">Bridge must be running ‚Äî Settings ‚öôÔ∏è</span></button>' +
        '</div>';
    }
  }

  function showBridgeNudge(btn) {
    const existing = btn.parentElement.querySelector('.bridge-nudge');
    if (existing) return;
    const nudge = document.createElement('div');
    nudge.className = 'bridge-nudge';
    nudge.textContent = 'üí° Start the Bridge first ‚Äî go to Settings ‚öôÔ∏è';
    btn.insertAdjacentElement('afterend', nudge);
    setTimeout(() => nudge.remove(), 3000);
  }

  function copyClaudeProjectPrompt(btn) {
    const prompt = 'Create a project called [name]';
    navigator.clipboard.writeText(prompt).catch(() => {});
    const hint = btn.querySelector('.ask-claude-copy-hint');
    const orig = hint.textContent;
    hint.textContent = '‚úì Copied! Paste in Claude Desktop';
    setTimeout(() => { hint.textContent = orig; }, 2000);
  }

  // ‚îÄ‚îÄ‚îÄ REFRESH STATUS ‚îÄ‚îÄ‚îÄ
  function refreshStatus() {
    const led = document.getElementById('bridgeLed');
    const status = document.getElementById('bridgeLedStatus');
    led.className = 'led amber';
    status.textContent = 'Checking‚Ä¶';
    // Force a new WebSocket attempt if disconnected
    if (!bridgeConnected) {
      connectToBridge();
    }
    setTimeout(() => updateLedPanel(bridgeConnected), 3200);
  }
  
  // ‚îÄ‚îÄ‚îÄ INITIALIZE ‚îÄ‚îÄ‚îÄ
  parent.postMessage({ pluginMessage: { type: 'load-projects' } }, '*');

  // Connect to bridge
  connectToBridge();

  // Set initial state (bridge assumed offline until WS connects)
  updateLedPanel(false);
  updateAddProjectArea(false);
  
  // ‚îÄ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabName + '-content').classList.add('active');
    });
  });
  
  // ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    const keys = { '1': 'projects', '2': 'fixes', '3': 'goals', '4': 'settings' };
    if (keys[e.key]) {
      document.querySelector('[data-tab="' + keys[e.key] + '"]').click();
    }
  });
  
  // ‚îÄ‚îÄ‚îÄ COPY PROMPT TEMPLATE ‚îÄ‚îÄ‚îÄ
  function copyPrompt() {
    const textarea = document.getElementById('promptTemplate');
    textarea.select();
    document.execCommand('copy');
    
    // Visual feedback
    const originalBg = textarea.style.background;
    textarea.style.background = '#1a4a1a';
    setTimeout(() => {
      textarea.style.background = originalBg;
    }, 200);
  }
  
  // ‚îÄ‚îÄ‚îÄ OPEN/CLOSE ADD PROJECT SHEET ‚îÄ‚îÄ‚îÄ
  function openAddProject() {
    document.getElementById('addProjectSheet').classList.add('open');
  }
  
  function closeAddProject() {
    document.getElementById('addProjectSheet').classList.remove('open');
  }
  
  // ‚îÄ‚îÄ‚îÄ SEND SELECTION TO CLAUDE (via Bridge) ‚îÄ‚îÄ‚îÄ
  function sendToClaude(mode) {
    if (!bridgeConnected) {
      alert('‚ö†Ô∏è Bridge server not connected!\n\nMake sure you started the bridge server:\nnpm start');
      return;
    }
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'send-to-claude',
        mode: mode // 'selection' or 'page'
      } 
    }, '*');
  }
  
  // ‚îÄ‚îÄ‚îÄ IMPORT JSON ‚îÄ‚îÄ‚îÄ
  function importJSON() {
    const jsonText = document.getElementById('jsonInput').value.trim();
    
    if (!jsonText) {
      alert('Please paste JSON from Claude!');
      return;
    }
    
    try {
      const data = JSON.parse(jsonText);
      
      if (!data.projectName || !data.goals || !Array.isArray(data.goals)) {
        alert('Invalid JSON. Need: {"projectName": "...", "goals": [...]}');
        return;
      }
      
      if (data.goals.length === 0) {
        alert('No goals found!');
        return;
      }
      
      const existing = allProjects.find(p => p.name === data.projectName);
      
      if (existing) {
        if (confirm('Project "' + data.projectName + '" exists. Replace goals with ' + data.goals.length + ' new ones?')) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'add-goals',
              projectId: existing.id,
              goals: data.goals,
              prdText: data.prdText || ''
            } 
          }, '*');
          
          document.getElementById('jsonInput').value = '';
          selectProject(existing.id);
          setTimeout(() => {
            document.querySelector('[data-tab="goals"]').click();
          }, 100);
        }
      } else {
        // Create new project with goals automatically
        parent.postMessage({ 
          pluginMessage: { 
            type: 'create-project', 
            name: data.projectName
          } 
        }, '*');
        
        window.pendingGoals = {
          goals: data.goals,
          prdText: data.prdText || ''
        };
        
        document.getElementById('jsonInput').value = '';
      }
      
    } catch (e) {
      alert('Invalid JSON: ' + e.message);
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ DELETE PROJECT ‚îÄ‚îÄ‚îÄ
  function deleteProject(projectId, event) {
    event.stopPropagation();
    
    if (!confirm('Delete this project?')) return;
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'delete-project', 
        projectId 
      } 
    }, '*');
  }
  
  // ‚îÄ‚îÄ‚îÄ SELECT PROJECT ‚îÄ‚îÄ‚îÄ
  function selectProject(projectId) {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'set-active-project', 
        projectId 
      } 
    }, '*');
  }
  
  // ‚îÄ‚îÄ‚îÄ TOGGLE GOAL ‚îÄ‚îÄ‚îÄ
  function toggleGoal(goalId) {
    if (!currentProject) return;
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'toggle-goal', 
        projectId: currentProject.id,
        goalId 
      } 
    }, '*');
  }
  
  // ‚îÄ‚îÄ‚îÄ MARK FIX DONE ‚îÄ‚îÄ‚îÄ
  function markFixDone(fixId) {
    if (!currentProject) return;
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'mark-fix-done', 
        projectId: currentProject.id,
        fixId 
      } 
    }, '*');
  }
  
  // ‚îÄ‚îÄ‚îÄ RENDER FUNCTIONS ‚îÄ‚îÄ‚îÄ
  function renderProjects(projects, activeProject) {
    const list = document.getElementById('projectList');
    
    if (projects.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div><div class="empty-text">No projects yet.<br>Create your first one below!</div></div>';
      return;
    }
    
    list.innerHTML = projects.map(p => 
      '<div class="project-item ' + (p.id === (activeProject && activeProject.id) ? 'active' : '') + '" onclick="selectProject(\'' + p.id + '\')">' +
        '<div class="project-name">' + p.name + '</div>' +
        '<div class="project-stats">' +
          '<span>' + (p.goals ? p.goals.length : 0) + ' goals</span>' +
          '<span>' + (p.fixes ? p.fixes.length : 0) + ' fixes</span>' +
        '</div>' +
        '<button class="project-delete" onclick="deleteProject(\'' + p.id + '\', event)">Delete</button>' +
      '</div>'
    ).join('');
  }
  
  // ‚îÄ‚îÄ‚îÄ CONFETTI ANIMATION ‚îÄ‚îÄ‚îÄ
  function triggerConfetti() {
    const colors = ['purple', 'yellow', 'blue', 'green', 'pink'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti confetti-' + colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.animation = 'confetti-fall ' + (2 + Math.random() * 2) + 's linear';
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 4000);
      }, i * 30);
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ‚îÄ
  function openQuickActions() {
    document.getElementById('quickActionsSheet').classList.add('open');
  }
  function closeQuickActions() {
    document.getElementById('quickActionsSheet').classList.remove('open');
  }

  function runAction(type) {
    closeQuickActions();
    // Switch to Fixes tab
    document.querySelector('[data-tab="fixes"]').click();

    // If bridge is offline, show an inline error rather than an infinite spinner
    if (!bridgeConnected) {
      addErrorResult('‚ö†Ô∏è Bridge is offline. Start the Bridge server (see Settings ‚öôÔ∏è) and try again.');
      return;
    }

    // Show analyzing indicator
    addAnalyzingIndicator(type);
    // Send to plugin / bridge
    parent.postMessage({ pluginMessage: { type: 'send-to-claude', mode: 'selection', action: type } }, '*');
    window.pendingActionType = type;
  }

  let _analyzeTimeout = null;

  function addAnalyzingIndicator(type) {
    const area = document.getElementById('resultsArea');
    document.getElementById('fixesEmpty').style.display = 'none';
    // Remove existing indicator if any
    const prev = document.getElementById('analyzingIndicator');
    if (prev) prev.remove();
    const labels = { grammar: 'Checking grammar', autolayout: 'Analyzing auto-layout', alignment: 'Checking alignment', contrast: 'Checking contrast' };
    const el = document.createElement('div');
    el.className = 'analyzing-indicator';
    el.id = 'analyzingIndicator';
    el.innerHTML =
      '<div class="analyzing-dots">' +
        '<div class="analyzing-dot"></div>' +
        '<div class="analyzing-dot"></div>' +
        '<div class="analyzing-dot"></div>' +
      '</div>' +
      '<span>' + (labels[type] || 'Analyzing') + '‚Ä¶</span>';
    area.appendChild(el);
    area.scrollTop = area.scrollHeight;

    // Show cancel button, hide Quick Actions + clear
    const mainBtn = document.getElementById('qaMainBtn');
    const cancelBtn = document.getElementById('qaCancelBtn');
    const clearBtn = document.getElementById('qaClearBtn');
    if (mainBtn) mainBtn.style.display = 'none';
    if (cancelBtn) cancelBtn.style.display = 'flex';
    if (clearBtn) clearBtn.style.display = 'none';

    // Auto-cancel after 30s with an error card
    if (_analyzeTimeout) clearTimeout(_analyzeTimeout);
    _analyzeTimeout = setTimeout(() => {
      removeAnalyzingIndicator();
      addErrorResult('‚è±Ô∏è Analysis timed out. Make sure the Bridge is running and a frame is selected, then try again.');
    }, 30000);
  }

  function removeAnalyzingIndicator() {
    const el = document.getElementById('analyzingIndicator');
    if (el) el.remove();

    // Restore Quick Actions button, hide cancel
    const mainBtn = document.getElementById('qaMainBtn');
    const cancelBtn = document.getElementById('qaCancelBtn');
    if (mainBtn) mainBtn.style.display = '';
    if (cancelBtn) cancelBtn.style.display = 'none';

    // Clear timeout
    if (_analyzeTimeout) { clearTimeout(_analyzeTimeout); _analyzeTimeout = null; }

    // Show clear btn if there are results
    updateClearBtn();
  }

  function cancelAction() {
    removeAnalyzingIndicator();
    window.pendingActionType = null;
  }

  function clearResults() {
    const area = document.getElementById('resultsArea');
    area.querySelectorAll('.result-item, .analyzing-indicator').forEach(el => el.remove());
    document.getElementById('fixesEmpty').style.display = 'block';
    updateClearBtn();
    window.pendingActionType = null;
  }

  function updateClearBtn() {
    const btn = document.getElementById('qaClearBtn');
    if (!btn) return;
    const hasItems = document.querySelectorAll('#resultsArea .result-item').length > 0;
    // Only show clear when not in cancel-mode (qaMainBtn visible)
    const mainVisible = document.getElementById('qaMainBtn').style.display !== 'none';
    btn.style.display = (hasItems && mainVisible) ? 'flex' : 'none';
  }

  function addErrorResult(msg) {
    document.getElementById('fixesEmpty').style.display = 'none';
    const area = document.getElementById('resultsArea');
    const el = document.createElement('div');
    el.className = 'result-item error';
    el.innerHTML =
      '<div class="result-action-badge" style="color:#ff6b6b;">‚ö†Ô∏è Error</div>' +
      '<div class="result-description">' + escHtml(msg) + '</div>';
    area.appendChild(el);
    area.scrollTop = area.scrollHeight;
    updateClearBtn();
  }

  // ‚îÄ‚îÄ‚îÄ RESTART CHAT ‚îÄ‚îÄ‚îÄ
  function restartChat() {
    document.getElementById('chatMessages').innerHTML = '';
    chatStep(null, 'start');
  }

  // ‚îÄ‚îÄ‚îÄ RESULT ITEMS ‚îÄ‚îÄ‚îÄ
  function addResultItem(result) {
    removeAnalyzingIndicator();
    document.getElementById('fixesEmpty').style.display = 'none';
    const area = document.getElementById('resultsArea');
    const action = result.action || window.pendingActionType || 'grammar';
    const el = document.createElement('div');
    el.className = 'result-item ' + action;
    el.id = 'result-' + result.id;

    const badges = { grammar: 'üî§ Grammar', autolayout: 'üìê Auto-layout', alignment: 'üìè Alignment', contrast: 'üé® Contrast' };
    let html = '<div class="result-action-badge">' + (badges[action] || action) + '</div>';
    if (result.nodeName) html += '<div class="result-node-name">in "' + escHtml(result.nodeName) + '"</div>';

    if (action === 'grammar') {
      const original  = result.original  || result.current || result.issue || '';
      const corrected = result.corrected || result.expected || result.suggestion || '';
      html +=
        '<div class="result-text-diff">' +
          '<div class="diff-original">' + escHtml(original) + '</div>' +
          '<div class="diff-corrected">‚Üí ' + escHtml(corrected) + '</div>' +
        '</div>' +
        '<div class="result-actions-row">' +
          '<button class="result-btn apply" onclick="applyGrammarFix(\'' + result.id + '\',\'' + escAttr(result.nodeId) + '\',\'' + escAttr(corrected) + '\',this)">‚úì Apply</button>' +
        '</div>';
    } else {
      const desc = result.description || result.suggestion || result.issue || '';
      html +=
        '<div class="result-description">' + escHtml(desc) + '</div>' +
        '<div class="result-actions-row">' +
          '<button class="result-btn annotate" onclick="annotateInFigma(\'' + result.id + '\',\'' + escAttr(result.nodeId) + '\',\'' + action + '\',this)">üìå Annotate</button>' +
        '</div>';
    }

    el.innerHTML = html;
    area.appendChild(el);
    area.scrollTop = area.scrollHeight;
    updateClearBtn();
  }

  function applyGrammarFix(resultId, nodeId, correctedText, btn) {
    btn.disabled = true;
    btn.textContent = '‚è≥';
    parent.postMessage({ pluginMessage: { type: 'apply-text-fix', nodeId, correctedText } }, '*');
    const item = document.getElementById('result-' + resultId);
    if (item) { item.classList.add('applied'); btn.textContent = '‚úì Applied'; }
  }

  function annotateInFigma(resultId, nodeId, actionType, btn) {
    btn.disabled = true;
    btn.textContent = '‚è≥';
    const item = document.getElementById('result-' + resultId);
    const desc = item ? (item.querySelector('.result-description') || {}).textContent || '' : '';
    parent.postMessage({ pluginMessage: { type: 'annotate-node', nodeId, actionType, description: desc } }, '*');
    if (item) { item.classList.add('applied'); btn.textContent = 'üìå Annotated'; }
  }

  function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function escAttr(s) {
    if (!s) return '';
    return String(s).replace(/'/g,"\\'").replace(/\n/g,' ');
  }

  // ‚îÄ‚îÄ‚îÄ RENAME LAYERS ‚îÄ‚îÄ‚îÄ
  function openRenameSheet() {
    document.getElementById('renameSheet').classList.add('open');
  }
  function closeRenameSheet() {
    document.getElementById('renameSheet').classList.remove('open');
  }
  function renameAction(type) {
    closeRenameSheet();
    if (type === 'native') {
      // Can't trigger Figma's native UI from a plugin ‚Äî just remind the user
      parent.postMessage({ pluginMessage: { type: 'notify', message: 'Press ‚åòR (Mac) or Ctrl+R (Windows) to open Figma\'s Rename Layers dialog' } }, '*');
      return;
    }
    parent.postMessage({ pluginMessage: { type: 'rename-layers', renameType: type } }, '*');
  }
  
  function renderGoals(project) {
    const list = document.getElementById('goalList');
    const empty = document.getElementById('goalsEmpty');
    const title = document.getElementById('goalsTitle');
    const progress = document.getElementById('goalsProgress');
    const fill = document.getElementById('progressFill');
    
    if (!project) {
      title.textContent = 'No project selected';
      progress.textContent = '0/0 complete (0%)';
      fill.style.width = '0%';
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    
    title.textContent = project.name;
    
    if (!project.goals || project.goals.length === 0) {
      progress.textContent = '0/0 complete (0%)';
      fill.style.width = '0%';
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    
    empty.style.display = 'none';
    
    const doneCount = project.goals.filter(g => g.status === 'done').length;
    const total = project.goals.length;
    const percent = Math.round((doneCount / total) * 100);
    
    progress.textContent = doneCount + '/' + total + ' complete (' + percent + '%)';
    fill.style.width = percent + '%';
    
    // üéâ CONFETTI when 100% complete!
    if (percent === 100 && doneCount > 0) {
      setTimeout(() => triggerConfetti(), 300);
    }
    
    list.innerHTML = project.goals.map(g =>
      '<div class="goal-item ' + (g.status === 'done' ? 'done' : '') + '" onclick="toggleGoal(\'' + g.id + '\')">' +
        '<div class="goal-checkbox"></div>' +
        '<div class="goal-text">' + g.text + '</div>' +
      '</div>'
    ).join('');
  }
  
  function renderFixes(project) {
    // Fixes tab now uses a conversation-style results layout (resultsArea).
    // The old #fixList element no longer exists ‚Äî only manage the empty-state placeholder.
    const empty = document.getElementById('fixesEmpty');
    if (!empty) return;
    const hasItems = document.querySelectorAll('#resultsArea .result-item').length > 0;
    if (!hasItems) {
      empty.style.display = 'block';
    }
  }
  
  function updateHeader(project) {
    const header = document.getElementById('headerProject');
    
    if (!project) {
      header.textContent = 'No project selected';
      header.classList.add('empty');
    } else {
      header.textContent = project.name;
      header.classList.remove('empty');
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ MESSAGE HANDLER ‚îÄ‚îÄ‚îÄ
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    if (!msg) return;
    
    console.log('üì® UI received:', msg.type);
    
    if (msg.type === 'projects-loaded' || msg.type === 'init-complete') {
      allProjects = msg.projects || [];
      currentProject = msg.activeProject;
      renderProjects(allProjects, currentProject);
      renderGoals(currentProject);
      renderFixes(currentProject);
      updateHeader(currentProject);
    }
    
    if (msg.type === 'project-created') {
      allProjects = msg.allProjects;
      currentProject = msg.project;
      renderProjects(allProjects, currentProject);
      updateHeader(currentProject);
      
      if (window.pendingGoals) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'add-goals',
            projectId: currentProject.id,
            goals: window.pendingGoals.goals,
            prdText: window.pendingGoals.prdText
          } 
        }, '*');
        
        window.pendingGoals = null;
        
        setTimeout(() => {
          document.querySelector('[data-tab="goals"]').click();
        }, 100);
      }
    }
    
    if (msg.type === 'project-deleted') {
      allProjects = msg.allProjects;
      currentProject = allProjects[0] || null;
      renderProjects(allProjects, currentProject);
      renderGoals(currentProject);
      renderFixes(currentProject);
      updateHeader(currentProject);
    }
    
    if (msg.type === 'active-project-changed') {
      currentProject = msg.project;
      renderProjects(allProjects, currentProject);
      renderGoals(currentProject);
      renderFixes(currentProject);
      updateHeader(currentProject);
    }
    
    if (msg.type === 'goals-updated') {
      const index = allProjects.findIndex(p => p.id === msg.project.id);
      if (index !== -1) {
        allProjects[index] = msg.project;
      }
      if (currentProject && currentProject.id === msg.project.id) {
        currentProject = msg.project;
      }
      renderGoals(currentProject);
      renderProjects(allProjects, currentProject);
    }
    
    if (msg.type === 'goal-toggled') {
      const index = allProjects.findIndex(p => p.id === msg.project.id);
      if (index !== -1) {
        allProjects[index] = msg.project;
      }
      if (currentProject && currentProject.id === msg.project.id) {
        currentProject = msg.project;
      }
      renderGoals(currentProject);
    }
    
    if (msg.type === 'fixes-updated') {
      const index = allProjects.findIndex(p => p.id === msg.project.id);
      if (index !== -1) {
        allProjects[index] = msg.project;
      }
      if (currentProject && currentProject.id === msg.project.id) {
        currentProject = msg.project;
      }
      renderFixes(currentProject);
      renderProjects(allProjects, currentProject);
    }
    
    if (msg.type === 'fix-marked-done') {
      const index = allProjects.findIndex(p => p.id === msg.project.id);
      if (index !== -1) {
        allProjects[index] = msg.project;
      }
      if (currentProject && currentProject.id === msg.project.id) {
        currentProject = msg.project;
      }
      renderFixes(currentProject);
    }
    
    if (msg.type === 'error') {
      console.error('Plugin error:', msg.message);
    }
    
    if (msg.type === 'claude-data-ready') {
      // Send data to bridge instead of copying to clipboard
      if (bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
        bridgeSocket.send(JSON.stringify({
          type: 'design-data',
          data: {
            mode: msg.mode,
            pageName: msg.pageName,
            fileKey: msg.fileKey,
            nodes: msg.data,
            projectName: currentProject?.name || 'Unknown'
          }
        }));
        
        alert('üì§ Design sent to Claude!\n\nNow tell Claude in chat:\n"Review my design against the PRD"');
      } else {
        alert('‚ö†Ô∏è Bridge not connected!\n\nStart the bridge server first.');
      }
    }
    
    if (msg.type === 'state-for-bridge') {
      // Forward state to bridge
      if (bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
        bridgeSocket.send(JSON.stringify({
          type: 'state-update',
          projects: msg.projects,
          activeProject: msg.activeProject
        }));
      }
    }
    
    if (msg.type === 'bridge-status') {
      updateConnectionIndicator(msg.connected);
    }

    if (msg.type === 'selection-changed') {
      const badge = document.getElementById('qaSelBadge');
      const desc  = document.getElementById('actionsSheetDesc');
      if (msg.count > 0) {
        const label = msg.count + (msg.count === 1 ? ' frame' : ' frames');
        if (badge) { badge.textContent = label; badge.style.display = 'inline'; }
        if (desc) {
          const warn = msg.count > 5 ? ' Large selections may take longer.' : '';
          desc.textContent = label + ' selected ‚Äî choose an action.' + warn;
        }
      } else {
        if (badge) badge.style.display = 'none';
        if (desc) desc.textContent = 'Select one or more frames, then choose an action.';
      }
    }
  };

  // ‚îÄ‚îÄ‚îÄ TROUBLESHOOTING CHAT ‚îÄ‚îÄ‚îÄ
  const CHAT_TREE = {
    start: {
      bot: "Hi! What's not working?",
      opts: [
        { label: "Bridge is offline / not connecting", next: 'bridge_start' },
        { label: "Figma Connector (MCP) not working", next: 'mcp_start' },
        { label: "Fixes aren't appearing in the panel", next: 'fixes_start' },
        { label: "Everything looks good!", next: 'all_good' }
      ]
    },
    bridge_start: {
      bot: "Let's fix your Bridge connection. Is Node.js installed on your computer?",
      opts: [
        { label: "Yes, Node.js is installed", next: 'bridge_node_yes' },
        { label: "No / Not sure", next: 'bridge_node_no' }
      ]
    },
    bridge_node_yes: {
      bot: "Good! Did you run start.sh (Mac/Linux) or start.bat (Windows) from inside the bridge folder?",
      opts: [
        { label: "Yes, I ran it", next: 'bridge_ran' },
        { label: "No ‚Äî how do I do that?", next: 'bridge_how_to_run' }
      ]
    },
    bridge_ran: {
      bot: "A few things to check:\n‚ë† Anything using port 3001? Restart the bridge.\n‚ë° Firewall blocking localhost? Try disabling temporarily.\n‚ë¢ Run directly: open a terminal ‚Üí cd into bridge folder ‚Üí node bridge-server.js\n\nHit ‚Üª Refresh above after fixing.",
      opts: [
        { label: "Still not working ‚Üí Open GitHub Issues", next: 'github' },
        { label: "Start over", next: 'start' }
      ]
    },
    bridge_how_to_run: {
      bot: "Open a terminal and navigate to the bridge folder:\n\n‚Ä¢ Mac/Linux:  bash start.sh\n‚Ä¢ Windows:    start.bat\n\nYou should see \"Bridge Server Running\" printed. Then hit ‚Üª Refresh.",
      opts: [
        { label: "I ran it ‚Äî let me refresh!", next: 'bridge_refresh' },
        { label: "Start over", next: 'start' }
      ]
    },
    bridge_refresh: {
      bot: "Hit the ‚Üª Refresh button above to check the status. If the LED turns green you're good to go!",
      opts: [
        { label: "It's green now!", next: 'bridge_fixed' },
        { label: "Still red‚Ä¶", next: 'bridge_ran' }
      ]
    },
    bridge_fixed: {
      bot: "Bridge is connected! Claude Desktop can now sync goals and fixes automatically. Happy designing!",
      opts: [{ label: "Start over", next: 'start' }]
    },
    bridge_node_no: {
      bot: "You need Node.js first ‚Äî it's free and takes about 2 minutes.\n\n1. Go to nodejs.org\n2. Download the LTS version\n3. Install it\n4. Come back and run the bridge",
      opts: [
        { label: "Got it, I'll install Node.js", next: 'bridge_how_to_run' },
        { label: "Start over", next: 'start' }
      ]
    },
    mcp_start: {
      bot: "The Figma Connector is set up in Claude Desktop, not here. Steps:\n\n1. Open Claude Desktop\n2. Settings ‚Üí Connectors\n3. Find \"Figma\" ‚Üí click Connect\n4. In Figma: right-click ‚Üí Plugins ‚Üí Development ‚Üí Figma Desktop Bridge ‚Üí Run",
      opts: [
        { label: "Done! What's next?", next: 'mcp_done' },
        { label: "I don't see Figma in Connectors", next: 'mcp_missing' }
      ]
    },
    mcp_done: {
      bot: "Claude can now read your Figma files directly! Try asking:\n\"Read my current Figma design and review it against the PRD.\"",
      opts: [{ label: "Start over", next: 'start' }]
    },
    mcp_missing: {
      bot: "You may need a newer version of Claude Desktop. The Figma Connector is available in version 0.7+.\n\nCheck for updates in the Claude Desktop app menu, then try again.",
      opts: [{ label: "Start over", next: 'start' }]
    },
    fixes_start: {
      bot: "To get fixes:\n‚ë† Select a frame in Figma\n‚ë° Go to the Fixes tab\n‚ë¢ Click a Quick Action (Grammar, Contrast, etc.)\n\nIs the Bridge connected (green LED)?",
      opts: [
        { label: "Yes, Bridge is green", next: 'fixes_bridge_ok' },
        { label: "No, Bridge is red", next: 'bridge_start' }
      ]
    },
    fixes_bridge_ok: {
      bot: "With Bridge connected, results come back automatically. Make sure:\n‚ë† A frame is actually selected in Figma\n‚ë° You're on the right project\n‚ë¢ Try the Full Review button for the most complete output.",
      opts: [
        { label: "That worked!", next: 'all_good' },
        { label: "Still nothing ‚Äî open GitHub Issues", next: 'github' }
      ]
    },
    all_good: {
      bot: "All set! Use Fixes to analyze designs and Goals to track PRD requirements. Happy designing!",
      opts: [{ label: "Start over", next: 'start' }]
    },
    github: {
      bot: "Head to GitHub Issues and describe what's happening. Include:\n‚Ä¢ Your OS (Mac/Windows/Linux)\n‚Ä¢ Node.js version (node --version)\n‚Ä¢ What the bridge terminal shows\n\nWe'll get it sorted!",
      opts: [{ label: "Start over", next: 'start' }]
    }
  };

  let chatHistory = [];

  function chatAddMsg(text, role) {
    const msgs = document.getElementById('chatMessages');
    const el = document.createElement('div');
    el.className = 'chat-msg ' + role;
    el.textContent = text;
    msgs.appendChild(el);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function chatSetOptions(opts) {
    const container = document.getElementById('chatOptions');
    container.innerHTML = '';
    opts.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'chat-opt-btn';
      btn.textContent = opt.label;
      btn.onclick = () => chatStep(opt.label, opt.next);
      container.appendChild(btn);
    });
  }

  function chatStep(userLabel, nodeKey) {
    if (userLabel) chatAddMsg(userLabel, 'user');
    const node = CHAT_TREE[nodeKey] || CHAT_TREE.start;
    setTimeout(() => {
      chatAddMsg(node.bot, 'bot');
      chatSetOptions(node.opts);
    }, userLabel ? 300 : 0);
  }

  function initChat() {
    chatStep(null, 'start');
  }

  // Initialize chat when settings tab is first viewed
  document.querySelector('[data-tab="settings"]').addEventListener('click', () => {
    if (document.getElementById('chatMessages').children.length === 0) {
      initChat();
    }
    updateLedPanel(bridgeConnected);
  });
</script>

</body>
</html>
