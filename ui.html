<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sidebot</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: #1a1a1a;
  color: #fff;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header {
  background: #2a2a2a;
  padding: 16px;
  border-bottom: 1px solid #3a3a3a;
}
.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.connection-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
}
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ff6b6b;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.header-badges { display: flex; align-items: center; gap: 6px; }
.beta-badge {
  background: #fbbf24;
  color: #000;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.project-title { font-size: 13px; opacity: 0.9; font-weight: 600; color: #fff; }
.project-title.empty { opacity: 0.5; font-style: italic; font-size: 11px; }

/* ‚îÄ‚îÄ‚îÄ OFFLINE BANNER ‚îÄ‚îÄ‚îÄ */
.api-banner {
  display: none;
  background: #2a1f0a;
  border-bottom: 1px solid #4a3510;
  padding: 8px 14px;
  font-size: 10px;
  line-height: 1.5;
  color: #fbbf24;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.api-banner.hidden { display: none !important; }
.api-banner-link {
  white-space: nowrap;
  color: #fbbf24;
  font-weight: 700;
  cursor: pointer;
  text-decoration: underline;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs {
  display: flex;
  background: #2a2a2a;
  border-bottom: 1px solid #3a3a3a;
  flex-shrink: 0;
}
.tab {
  flex: 1;
  padding: 10px 8px;
  font-size: 11px;
  text-align: center;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  opacity: 0.6;
}
.tab:hover { opacity: 0.9; background: #333; }
.tab.active { opacity: 1; border-bottom-color: #7B4FBE; background: #333; }

/* ‚îÄ‚îÄ‚îÄ TAB CONTENT ‚îÄ‚îÄ‚îÄ */
.tab-content {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  min-height: 0; /* required for flex children to scroll correctly */
}
.tab-content.active { display: block; }

/* ‚îÄ‚îÄ‚îÄ NOTION BLOCK ‚îÄ‚îÄ‚îÄ */
.notion-block {
  background: #1e2538;
  border: 1px solid #2d3a5a;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 12px;
}
.notion-block-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: #1a2033;
  border-bottom: 1px solid #2d3a5a;
}
.notion-block-title {
  font-size: 11px;
  font-weight: 700;
  color: #60a5fa;
  display: flex;
  align-items: center;
  gap: 6px;
}
.notion-block-body {
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.notion-status-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.notion-status-chip.connected { background: #1a3d1a; border: 1px solid #2a5a2a; color: #4ade80; }
.notion-status-chip.disconnected { background: #2d1a3d; border: 1px solid #4a2a5a; color: #a78bfa; }

.notion-search-result {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: #2a2a3a;
  border: 1px solid #3a3a5a;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 6px;
}
.notion-search-result:hover { border-color: #60a5fa; background: #1e2538; }

/* ‚îÄ‚îÄ‚îÄ PROJECTS TAB ‚îÄ‚îÄ‚îÄ */
.project-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}
.project-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.project-item:hover { border-color: #7B4FBE; background: #333; }
.project-item.active { border-color: #7B4FBE; background: #333; }
.project-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.project-stats { font-size: 10px; opacity: 0.6; display: flex; gap: 12px; }
.project-delete {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #3a3a3a;
  border: none;
  color: #ff6b6b;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 10px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}
.project-item:hover .project-delete { opacity: 1; }
.project-delete:hover { background: #ff6b6b; color: #fff; }

/* ‚îÄ‚îÄ‚îÄ ASK CLAUDE BUTTON ‚îÄ‚îÄ‚îÄ */
.ask-claude-btn {
  width: 100%;
  padding: 11px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-bottom: 12px;
}
.ask-claude-btn.online {
  background: #7B4FBE;
  border: none;
  color: #fff;
}
.ask-claude-btn.online:hover { background: #6a3fa8; transform: translateY(-1px); }
.ask-claude-btn.offline {
  background: transparent;
  border: 1px dashed #4a4a4a;
  color: #555;
}
.ask-claude-btn.offline:hover { border-color: #666; color: #888; }

/* ‚îÄ‚îÄ‚îÄ ADD PROJECT ‚îÄ‚îÄ‚îÄ */
.btn-add-project {
  width: 100%;
  padding: 14px;
  background: #2a2a2a;
  border: 2px dashed #7B4FBE;
  border-radius: 6px;
  color: #7B4FBE;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 4px;
}
.btn-add-project:hover { background: #333; border-color: #9b6fde; color: #9b6fde; }

/* ‚îÄ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ‚îÄ */
.bottom-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: none; }
.bottom-sheet.open { display: block; }
.bottom-sheet-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); animation: fadeIn 0.2s; }
.bottom-sheet-content { position: absolute; bottom: 0; left: 0; width: 100%; max-height: 82%; background: #1a1a1a; border-radius: 12px 12px 0 0; animation: slideUp 0.3s; overflow-y: auto; }
.sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #3a3a3a; position: sticky; top: 0; background: #1a1a1a; z-index: 1; }
.sheet-title { font-size: 14px; font-weight: 600; }
.sheet-close { background: #2a2a2a; border: none; color: #fff; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.sheet-close:hover { background: #3a3a3a; }
.sheet-body { padding: 16px; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
input, .notion-input {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 12px;
  margin-bottom: 8px;
  outline: none;
  transition: border-color 0.2s;
}
input:focus, .notion-input:focus { border-color: #7B4FBE; }
textarea {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 10px;
  font-family: monospace;
  resize: vertical;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn-primary { width: 100%; padding: 10px; background: #7B4FBE; color: #fff; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-primary:hover { background: #6a3fa8; }
.btn-success { width: 100%; padding: 10px; background: #4ade80; color: #000; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
.btn-success:hover { background: #3ac970; }
.btn-secondary { padding: 10px; background: #2a2a2a; border: 1px solid #7B4FBE; color: #fff; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-secondary:hover { background: #7B4FBE; }
.btn-download { display: block; width: 100%; padding: 12px; background: #7B4FBE; color: #fff; text-align: center; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 600; margin-bottom: 12px; transition: all 0.2s; }
.btn-download:hover { background: #6a3fa8; transform: translateY(-1px); }

/* ‚îÄ‚îÄ‚îÄ SECTION LABELS ‚îÄ‚îÄ‚îÄ */
.section-title { font-size: 11px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.section-desc { font-size: 10px; opacity: 0.6; margin-bottom: 8px; line-height: 1.4; }

/* ‚îÄ‚îÄ‚îÄ SEND TO CLAUDE SECTION ‚îÄ‚îÄ‚îÄ */
.send-claude-section { margin-bottom: 16px; padding: 12px; background: #2a2a2a; border-radius: 6px; border: 1px solid #3a3a3a; }

/* ‚îÄ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ‚îÄ */
.goals-header { text-align: center; margin-bottom: 20px; }
.goals-title { font-size: 13px; font-weight: 600; margin-bottom: 8px; }
.goals-progress { font-size: 11px; opacity: 0.7; }
.progress-bar { width: 100%; height: 6px; background: #2a2a2a; border-radius: 3px; overflow: hidden; margin-top: 8px; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #7B4FBE, #9b6fde); transition: width 0.3s; }
.goal-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.goal-item { background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; padding: 12px; display: flex; align-items: flex-start; gap: 10px; cursor: pointer; transition: all 0.2s; }
.goal-item:hover { background: #333; }
.goal-checkbox { width: 18px; height: 18px; border: 2px solid #3a3a3a; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-top: 2px; }
.goal-item.done .goal-checkbox { background: #7B4FBE; border-color: #7B4FBE; }
.goal-item.done .goal-checkbox::after { content: '‚úì'; color: #fff; font-size: 12px; font-weight: 700; }
.goal-text { flex: 1; font-size: 12px; line-height: 1.5; }
.goal-item.done .goal-text { opacity: 0.5; text-decoration: line-through; }

/* ‚îÄ‚îÄ‚îÄ GOAL HOVER ACTIONS + DRAG ‚îÄ‚îÄ‚îÄ */
.goal-item { position: relative; cursor: default; }
.goal-item:hover { background: #2e2e2e; }
.goal-drag-handle {
  cursor: grab; color: #444; font-size: 14px; flex-shrink: 0;
  padding: 0 2px; user-select: none; transition: color 0.15s;
}
.goal-item:hover .goal-drag-handle { color: #777; }
.goal-drag-handle:active { cursor: grabbing; }
.goal-hover-actions {
  display: flex; gap: 2px; opacity: 0; transition: opacity 0.15s; flex-shrink: 0;
}
.goal-item:hover .goal-hover-actions { opacity: 1; }
.goal-action-btn {
  background: none; border: none; color: #666; cursor: pointer;
  padding: 3px 5px; font-size: 13px; border-radius: 4px; transition: all 0.15s; line-height: 1;
}
.goal-action-btn:hover        { background: #3a3a3a; color: #fff; }
.goal-action-btn.del:hover    { background: rgba(255,107,107,0.15); color: #ff6b6b; }
.goal-item.drag-over          { border-color: #7B4FBE; background: #261a40; }
.goal-item.dragging           { opacity: 0.35; }

/* ‚îÄ‚îÄ‚îÄ FIXES ‚îÄ‚îÄ‚îÄ */
.fix-list { display: flex; flex-direction: column; gap: 12px; }
.fix-item { background: #2a2a2a; border: 1px solid #3a3a3a; border-left: 3px solid #ff6b6b; border-radius: 6px; padding: 12px; }
.fix-item.done { border-left-color: #4ade80; opacity: 0.6; }
.fix-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.fix-title { font-size: 12px; font-weight: 600; color: #ff6b6b; }
.fix-item.done .fix-title { color: #4ade80; }
.fix-description { font-size: 11px; line-height: 1.5; margin-bottom: 10px; opacity: 0.8; }
.fix-actions { display: flex; gap: 6px; }
.fix-btn { flex: 1; padding: 6px 10px; font-size: 10px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
.fix-btn.done-btn { background: #4ade80; color: #000; }
.fix-btn.done-btn:hover { background: #3ac970; }
.fix-btn.done-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state { text-align: center; padding: 40px 20px; opacity: 0.5; }
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-text { font-size: 12px; line-height: 1.6; }

/* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
.settings-section { margin-bottom: 24px; }
.settings-header { font-size: 12px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; gap: 6px; }
.settings-header-left { display: flex; align-items: center; gap: 6px; }
.settings-description { font-size: 10px; opacity: 0.6; margin-bottom: 12px; line-height: 1.5; }
.help-text { font-size: 10px; opacity: 0.5; line-height: 1.6; margin-top: 8px; }
.keyboard-shortcuts { display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 10px; padding: 12px; background: #2a2a2a; border-radius: 4px; }
.key { background: #1a1a1a; padding: 4px 8px; border-radius: 3px; font-weight: 600; text-align: center; min-width: 24px; }

/* ‚îÄ‚îÄ‚îÄ LED STATUS ROWS ‚îÄ‚îÄ‚îÄ */
.status-rows { display: flex; flex-direction: column; gap: 6px; }
.status-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 9px 12px;
  background: #222;
  border: 1px solid #333;
  border-radius: 6px;
}
.status-row-left { min-width: 0; }
.status-row-name { font-size: 11px; font-weight: 600; }
.status-row-sub  { font-size: 9px; color: #555; margin-top: 2px; }
.led-chip {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 3px 9px;
  background: #1a1a1a;
  border-radius: 20px;
  font-size: 9px;
  font-weight: 700;
  border: 1px solid #333;
  flex-shrink: 0;
  white-space: nowrap;
}
.dot2 { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.dot2.green  { background: #4ade80; box-shadow: 0 0 5px #4ade80; }
.dot2.red    { background: #ff6b6b; }
.dot2.amber  { background: #fbbf24; }
@keyframes ledpulse { 0%,100%{opacity:1} 50%{opacity:.4} }
.dot2.green { animation: ledpulse 2s infinite; }

/* ‚îÄ‚îÄ‚îÄ BRIDGE SETUP CARD ‚îÄ‚îÄ‚îÄ */
.setup-card {
  background: #222;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 14px;
  margin-bottom: 12px;
}
.mode-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 700;
  margin-bottom: 10px;
}
.mode-badge.online  { background: #1a3d1a; border: 1px solid #2a5a2a; color: #4ade80; }
.mode-badge.offline { background: #3d2a1a; border: 1px solid #5a3a1a; color: #fbbf24; }

/* ‚îÄ‚îÄ‚îÄ TROUBLESHOOTING ‚îÄ‚îÄ‚îÄ */
.troubleshoot-list { display: flex; flex-direction: column; gap: 6px; }
.troubleshoot-item {
  background: #222;
  border: 1px solid #333;
  border-left: 3px solid #4a4a4a;
  border-radius: 6px;
  overflow: hidden;
}
.troubleshoot-q {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  font-weight: 600;
  padding: 10px 12px;
  cursor: pointer;
  user-select: none;
}
.troubleshoot-q:hover { background: #2a2a2a; }
.troubleshoot-chevron { font-size: 9px; color: #666; transition: transform 0.2s; }
.troubleshoot-item.open .troubleshoot-chevron { transform: rotate(180deg); }
.troubleshoot-a {
  display: none;
  font-size: 10px;
  color: #888;
  line-height: 1.6;
  padding: 0 12px 10px 12px;
  border-top: 1px solid #2a2a2a;
  padding-top: 8px;
}
.troubleshoot-item.open .troubleshoot-a { display: block; }
.troubleshoot-a code { background: #333; padding: 1px 5px; border-radius: 3px; font-size: 9px; color: #ddd; }

/* ‚îÄ‚îÄ‚îÄ ACTION BUTTONS ‚îÄ‚îÄ‚îÄ */
.fixes-actions-section { background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; padding: 16px; margin-bottom: 16px; }
.action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.action-btn { display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.action-btn:hover { background: #333; border-color: #7B4FBE; transform: translateY(-1px); }
.action-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.action-icon { font-size: 16px; }
.action-label { flex: 1; }

/* ‚îÄ‚îÄ‚îÄ RENAME STATUS ‚îÄ‚îÄ‚îÄ */
.rename-status { margin-top: 10px; font-size: 10px; line-height: 1.6; display: none; }

/* ‚îÄ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ */
#fixes-content.active { display: flex; flex-direction: column; padding: 0; overflow: hidden; }
.chat-shortcuts { display: flex; gap: 6px; padding: 10px 12px 6px; flex-wrap: wrap; flex-shrink: 0; border-bottom: 1px solid #2a2a2a; }
.chat-chip { background: #2a2a2a; border: 1px solid #3a3a3a; color: #ccc; padding: 4px 10px; border-radius: 12px; font-size: 10px; cursor: pointer; white-space: nowrap; }
.chat-chip:hover { background: #333; border-color: #555; }
.chat-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
.chat-empty { text-align: center; color: #555; font-size: 11px; line-height: 1.6; margin: auto; }
.chat-bubble { max-width: 88%; padding: 8px 12px; border-radius: 10px; font-size: 11px; line-height: 1.6; word-break: break-word; }
.chat-bubble.user { background: #2563eb; color: #fff; align-self: flex-end; border-bottom-right-radius: 3px; }
.chat-bubble.assistant { background: #2a2a2a; color: #ddd; align-self: flex-start; border-bottom-left-radius: 3px; }
.chat-bubble.typing { color: #666; font-style: italic; }
.chat-fix-card { background: #1e1e1e; border: 1px solid #3a3a3a; border-left: 3px solid #fbbf24; border-radius: 6px; padding: 8px 10px; margin-top: 6px; font-size: 10px; }
.chat-fix-card .fix-issue { font-weight: 600; color: #fff; margin-bottom: 3px; }
.chat-fix-card .fix-detail { color: #888; }
.chat-fix-done-btn { margin-top: 5px; background: #2a2a2a; border: 1px solid #444; color: #888; padding: 2px 8px; border-radius: 4px; font-size: 9px; cursor: pointer; }
.chat-fix-done-btn:hover { color: #4ade80; border-color: #4ade80; }
.chat-input-bar { display: flex; align-items: flex-end; gap: 6px; padding: 8px 12px; border-top: 1px solid #2a2a2a; flex-shrink: 0; }
.chat-input { flex: 1; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 8px; color: #fff; font-size: 11px; padding: 7px 10px; resize: none; font-family: inherit; max-height: 80px; overflow-y: auto; line-height: 1.5; }
.chat-input:focus { outline: none; border-color: #555; }
.chat-send-btn { background: #2563eb; border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; font-size: 12px; cursor: pointer; flex-shrink: 0; }
.chat-send-btn:hover { background: #1d4ed8; }
.chat-send-btn:disabled { background: #333; color: #555; cursor: default; }

/* ‚îÄ‚îÄ‚îÄ API KEY INLINE ROW (in settings LED section) ‚îÄ‚îÄ‚îÄ */
.api-key-row {
  display: flex; gap: 6px; padding: 8px 12px 10px;
  background: #1a1a1a; border: 1px solid #333; border-top: none;
  border-radius: 0 0 6px 6px; margin-top: -4px; align-items: center;
}
.api-key-row input {
  flex: 1; margin-bottom: 0; padding: 6px 8px; font-size: 11px;
  background: #222; border-color: #3a3a3a; border-radius: 4px;
}
.api-key-save   { padding: 6px 12px; background: #7B4FBE; color: #fff; border: none; border-radius: 4px; font-size: 10px; font-weight: 700; cursor: pointer; white-space: nowrap; }
.api-key-save:hover { background: #6a3fa8; }
.api-key-delete { padding: 6px 10px; background: transparent; color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 4px; font-size: 10px; font-weight: 700; cursor: pointer; white-space: nowrap; }
.api-key-delete:hover { background: #ff6b6b22; }
.status-row-has-input { border-radius: 6px 6px 0 0; border-bottom: none; }

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
.tab-content::-webkit-scrollbar { width: 6px; }
.tab-content::-webkit-scrollbar-track { background: #1a1a1a; }
.tab-content::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 3px; }
.tab-content::-webkit-scrollbar-thumb:hover { background: #4a4a4a; }

/* ‚îÄ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ */
@keyframes confetti-fall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
.confetti { position: fixed; width: 10px; height: 10px; z-index: 9999; pointer-events: none; }
.confetti-purple { background: #7B4FBE; }
.confetti-yellow { background: #fbbf24; }
.confetti-blue   { background: #3b82f6; }
.confetti-green  { background: #10b981; }
.confetti-pink   { background: #ec4899; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<div class="header">
  <div class="header-top">
    <div class="connection-status">
      <div class="status-dot" id="headerDot"></div>
      <span id="headerStatus">Offline</span>
    </div>
    <div class="header-badges">
      <div class="beta-badge">BETA</div>
      <div class="beta-badge">v1.1</div>
    </div>
  </div>
  <div class="project-title empty" id="headerProject">No project selected</div>
</div>

<!-- ‚îÄ‚îÄ OFFLINE BANNER ‚îÄ‚îÄ -->
<div class="api-banner" id="apiBanner">
  <span>‚ö†Ô∏è Bridge offline<br>Only offline features available</span>
  <span class="api-banner-link" onclick="goToSettings()">‚Üí Setup in Settings</span>
</div>

<!-- ‚îÄ‚îÄ TABS ‚îÄ‚îÄ -->
<div class="tabs">
  <div class="tab active" data-tab="projects">üìÅ Projects</div>
  <div class="tab" data-tab="fixes">üí¨ Chat</div>
  <div class="tab" data-tab="goals">üéØ Goals</div>
  <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROJECTS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content active" id="projects-content">

  <!-- Notion PRD Block -->
  <div class="notion-block" id="notionBlock">
    <div class="notion-block-header">
      <div class="notion-block-title">üìù Notion PRD</div>
      <div class="notion-status-chip disconnected" id="notionStatusChip">Not Connected</div>
    </div>
    <div class="notion-block-body" id="notionBlockBody">
      <button class="btn-primary" onclick="openNotionSheet()" style="font-size:11px;padding:8px;">
        üîó Connect Notion
      </button>
    </div>
  </div>

  <!-- Ask Claude button -->
  <button class="ask-claude-btn offline" id="askClaudeBtn" onclick="askClaude()">
    <span>ü§ñ</span>
    <span id="askClaudeBtnLabel">Ask Claude to Add Project ‚Äî Bridge offline</span>
  </button>

  <!-- Project list -->
  <div class="project-list" id="projectList"></div>

  <button class="btn-add-project" onclick="openAddProject()">+ Add New Project</button>
</div>

<!-- Add Project Sheet -->
<div class="bottom-sheet" id="addProjectSheet">
  <div class="bottom-sheet-overlay" onclick="closeAddProject()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">üìã Add New Project</div>
      <button class="sheet-close" onclick="closeAddProject()">‚úï</button>
    </div>
    <div class="sheet-body">
      <div class="section-desc">1. Copy this prompt and paste in Claude Desktop with your PRD:</div>
      <textarea id="promptTemplate" readonly rows="3" onclick="copyPrompt()" style="margin-bottom:12px;opacity:0.8;cursor:pointer;background:#2a2a2a;font-size:10px;">Analyze this PRD and create JSON for Sidebot:

[Paste your PRD here]

Return format: {"projectName": "...", "goals": ["...", "..."]}</textarea>
      <div class="section-desc" style="margin-top:12px;">2. Paste Claude's JSON response here:</div>
      <textarea id="jsonInput" rows="4" placeholder='{"projectName": "My Project", "goals": ["Goal 1", "Goal 2"]}' style="font-size:11px;"></textarea>
      <button class="btn-success" onclick="importJSON()">‚ú® Import Project + Goals</button>
    </div>
  </div>
</div>

<!-- Notion Sheet -->
<div class="bottom-sheet" id="notionSheet">
  <div class="bottom-sheet-overlay" onclick="closeNotionSheet()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">üìù Connect Notion PRD</div>
      <button class="sheet-close" onclick="closeNotionSheet()">‚úï</button>
    </div>
    <div class="sheet-body">
      <div class="section-desc" style="line-height:1.6;">
        Create an integration token at <a href="https://www.notion.so/my-integrations" target="_blank" style="color:#60a5fa;text-decoration:underline;font-weight:600;">notion.so/my-integrations</a>, then share your PRD page with it.
      </div>
      <input type="password" id="notionTokenInput" placeholder="secret_xxxxxxxxxxxxx" autocomplete="off">
      <button class="btn-primary" onclick="saveNotionToken()">Save Token</button>
      <div id="notionSearchArea" style="display:none;margin-top:16px;border-top:1px solid #3a3a3a;padding-top:16px;">
        <div class="section-title">Search PRD Pages</div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input type="text" id="notionSearchInput" placeholder="Search pages‚Ä¶" style="flex:1;margin-bottom:0;">
          <button class="btn-secondary" onclick="searchNotionPages()" style="white-space:nowrap;">Search</button>
        </div>
        <div id="notionResults"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOALS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="goals-content">
  <div class="goals-header">
    <div class="goals-title" id="goalsTitle">No project selected</div>
    <div class="goals-progress">
      <span id="goalsProgress">0/0 complete (0%)</span>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="send-claude-section">
    <div style="font-size:11px;font-weight:600;margin-bottom:8px;opacity:0.7;">üì§ Send to Claude for Review</div>
    <div style="display:flex;gap:8px;">
      <button class="btn-secondary" onclick="sendToClaude('selection')" style="flex:1;">üìç Selection</button>
      <button class="btn-secondary" onclick="sendToClaude('page')" style="flex:1;">üìÑ Current Page</button>
    </div>
  </div>

  <div class="goal-list" id="goalList"></div>
  <div class="empty-state" id="goalsEmpty">
    <div class="empty-icon">üéØ</div>
    <div class="empty-text">No goals yet.<br>Add a project with goals to track progress.</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="fixes-content">

  <!-- Shortcut chips -->
  <div class="chat-shortcuts">
    <button class="chat-chip" onclick="chatShortcut('grammar')">üî§ Grammar</button>
    <button class="chat-chip" onclick="chatShortcut('contrast')">üé® Contrast</button>
    <button class="chat-chip" onclick="chatShortcut('consistency')">üìê Consistency</button>
    <button class="chat-chip" onclick="chatShortcut('edge-cases')">üîç Edge Cases</button>
  </div>

  <!-- Messages -->
  <div class="chat-messages" id="chatMessages">
    <div class="chat-empty" id="chatEmpty">
      <div style="font-size:28px">üí¨</div>
      <div>Ask Claude anything about your design.<br>Select a frame first for context.</div>
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input-bar">
    <textarea id="chatInput" class="chat-input" placeholder="Ask Claude about your design‚Ä¶" rows="1"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}"></textarea>
    <button class="chat-send-btn" onclick="sendChat()">‚ñ∂</button>
  </div>
</div>

<!-- Fixes Actions Bottom Sheet -->
<div class="bottom-sheet" id="fixesActionsSheet">
  <div class="bottom-sheet-overlay" onclick="closeFixesActions()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">‚ö° Actions</div>
      <button class="sheet-close" onclick="closeFixesActions()">‚úï</button>
    </div>
    <div class="sheet-body">

      <!-- Design Checks -->
      <div class="section-title">Design Checks</div>
      <div class="section-desc">Select a frame, then click an action. Results will appear in the Fixes tab.</div>
      <div class="action-buttons" style="margin-bottom:20px;">
        <button class="action-btn" onclick="checkGrammar()">
          <span class="action-icon">üî§</span>
          <span class="action-label">Check Grammar</span>
        </button>
        <button class="action-btn" onclick="checkContrast()">
          <span class="action-icon">üé®</span>
          <span class="action-label">Contrast</span>
        </button>
        <button class="action-btn" onclick="checkConsistency()" style="grid-column:1/-1;">
          <span class="action-icon">üìê</span>
          <span class="action-label">Check Consistency ‚Äî positions, fonts, styles</span>
        </button>
        <button class="action-btn" onclick="checkEdgeCases()" style="grid-column:1/-1;">
          <span class="action-icon">üß™</span>
          <span class="action-label">Edge Cases ‚Äî adds sticky notes to canvas</span>
        </button>
      </div>

      <!-- Layer Tools -->
      <div class="section-title">‚úèÔ∏è Layer Tools</div>
      <div class="section-desc">Renames layers in selection (or full page if nothing selected)</div>
      <div class="action-buttons">
        <button class="action-btn" id="renameContentBtn" onclick="renameLayers('from-content')">
          <span class="action-icon">üìù</span>
          <span class="action-label">From Content</span>
        </button>
        <button class="action-btn" id="renameCleanBtn" onclick="renameLayers('clean')">
          <span class="action-icon">üßπ</span>
          <span class="action-label">Clean Names</span>
        </button>
        <button class="action-btn" id="renameTypeBtn" onclick="renameLayers('by-type')">
          <span class="action-icon">üè∑Ô∏è</span>
          <span class="action-label">By Type</span>
        </button>
        <button class="action-btn" id="renameNumBtn" onclick="renameLayers('number')">
          <span class="action-icon">üî¢</span>
          <span class="action-label">Add Numbers</span>
        </button>
      </div>
      <div class="rename-status" id="renameStatus" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="settings-content">

  <!-- Live Status -->
  <div class="settings-section">
    <div class="settings-header">
      <div class="settings-header-left">üí° Live Status</div>
      <button onclick="refreshStatus()" style="background:transparent;border:1px solid #3a3a3a;color:#888;padding:3px 10px;border-radius:4px;font-size:10px;cursor:pointer;">‚Üª Refresh</button>
    </div>

    <div id="modeBadgeWrap" style="margin-bottom:10px;">
      <div class="mode-badge offline" id="modeBadge">
        <div class="dot2 amber"></div>
        <span id="modeBadgeText">Manual Mode</span>
      </div>
    </div>

    <div class="status-rows">

      <!-- Claude API row + inline key input -->
      <div class="status-row status-row-has-input">
        <div class="status-row-left">
          <div class="status-row-name"><a href="https://console.anthropic.com/" target="_blank" style="color:#fff;text-decoration:underline;text-decoration-color:#555;">Claude API ‚Üó</a></div>
          <div class="status-row-sub" id="claudeApiSub">No key saved</div>
        </div>
        <div class="led-chip">
          <div class="dot2 red" id="claudeApiDot"></div>
          <span id="claudeApiLedText">Not set</span>
        </div>
      </div>
      <div class="api-key-row">
        <input type="password" id="claudeApiInput" placeholder="sk-ant-api03-‚Ä¶" autocomplete="off">
        <button class="api-key-save" onclick="saveClaudeApiKey()">Save</button>
        <button class="api-key-delete" id="claudeApiDeleteBtn" style="display:none;" onclick="deleteClaudeApiKey()">Delete</button>
      </div>

      <!-- Bridge Server row -->
      <div class="status-row" style="margin-top:6px;">
        <div class="status-row-left">
          <div class="status-row-name">Bridge Server</div>
          <div class="status-row-sub" id="bridgeSubText">Not running</div>
        </div>
        <div class="led-chip" id="bridgeLed">
          <div class="dot2 red" id="bridgeDot"></div>
          <span id="bridgeLedText">Offline</span>
        </div>
      </div>

      <!-- Notion row + inline token input -->
      <div class="status-row status-row-has-input" style="margin-top:6px;">
        <div class="status-row-left">
          <div class="status-row-name"><a href="https://www.notion.so/my-integrations" target="_blank" style="color:#fff;text-decoration:underline;text-decoration-color:#555;">Notion ‚Üó</a></div>
          <div class="status-row-sub" id="notionSubText">Token not set</div>
        </div>
        <div class="led-chip" id="notionLed">
          <div class="dot2 amber" id="notionDot"></div>
          <span id="notionLedText">Setup needed</span>
        </div>
      </div>
      <div class="api-key-row">
        <input type="password" id="notionTokenSettingsInput" placeholder="secret_‚Ä¶" autocomplete="off">
        <button class="api-key-save" onclick="saveNotionTokenInline()">Save</button>
        <button class="api-key-delete" id="notionDeleteBtn" style="display:none;" onclick="deleteNotionToken()">Delete</button>
      </div>

      <!-- Figma MCP Connector row -->
      <div class="status-row" style="margin-top:6px;">
        <div class="status-row-left">
          <div class="status-row-name">Figma MCP Connector</div>
          <div class="status-row-sub">Claude Desktop ‚Üí Settings ‚Üí Connectors</div>
        </div>
        <div class="led-chip"><div class="dot2 amber"></div>Check Claude</div>
      </div>
    </div>
  </div>

  <!-- Bridge Setup (shown when offline) -->
  <div class="settings-section" id="bridgeSetupSection">
    <div class="settings-header"><div class="settings-header-left">‚ö° Enable Seamless Mode</div></div>
    <div class="settings-description">Download the free Bridge app for automatic sync with Claude Desktop.</div>
    <a href="https://github.com/AnderMagri/Sidebot/releases/latest" target="_blank" class="btn-download">
      üì• Download SidebotBridge.app
    </a>
    <div class="help-text">
      <strong>Quick Setup:</strong><br>
      1. Download SidebotBridge.zip from GitHub Releases<br>
      2. Unzip and open <strong>SidebotBridge.app</strong><br>
      &nbsp;&nbsp;&nbsp;(Right-click ‚Üí Open if macOS blocks it;<br>
      &nbsp;&nbsp;&nbsp;or System Settings ‚Üí Privacy &amp; Security ‚Üí Open Anyway)<br>
      3. Click ‚Üª Refresh above ‚Äî you're live! üü¢
    </div>
  </div>

  <!-- Keyboard Shortcuts -->
  <div class="settings-section">
    <div class="settings-header"><div class="settings-header-left">‚å®Ô∏è Keyboard Shortcuts</div></div>
    <div class="keyboard-shortcuts">
      <span class="key">1</span><span>Projects</span>
      <span class="key">2</span><span>Fixes</span>
      <span class="key">3</span><span>Goals</span>
      <span class="key">4</span><span>Settings</span>
    </div>
  </div>

  <!-- Figma Desktop Bridge -->
  <div class="settings-section">
    <div class="settings-header"><div class="settings-header-left">üîå Figma MCP Connector (Optional)</div></div>
    <div class="help-text" style="opacity:0.7;font-size:10px;">
      <strong style="color:#fff;">What it does:</strong><br>
      Lets Claude read your Figma files directly ‚Äî no copy/paste needed.<br><br>
      <strong style="color:#fff;">How to install:</strong><br>
      1. Open Claude Desktop ‚Üí Settings ‚Üí Connectors<br>
      2. Find "Figma" and click Connect<br>
      3. In Figma: Right-click ‚Üí Plugins ‚Üí Development ‚Üí Figma Desktop Bridge ‚Üí Run<br><br>
      <strong style="color:#fff;">When enabled, Claude can:</strong><br>
      ‚Ä¢ Read designs automatically<br>
      ‚Ä¢ Analyze multiple frames at once<br>
      ‚Ä¢ Check consistency across screens<br><br>
      ‚ö†Ô∏è This is separate from SidebotBridge.app
    </div>
  </div>

  <!-- Troubleshooting -->
  <div class="settings-section">
    <div class="settings-header"><div class="settings-header-left">üõ†Ô∏è Troubleshooting</div></div>
    <div class="troubleshoot-list">

      <div class="troubleshoot-item warn">
        <div class="troubleshoot-q" onclick="toggleTroubleshoot(this)">
          Bridge shows Offline after opening the app
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-a">
          Wait 3‚Äì5 seconds then click <strong>‚Üª Refresh</strong> above. The bridge takes a moment to start.<br>
          If still offline, make sure no other app is using port <code>3001</code>.
        </div>
      </div>

      <div class="troubleshoot-item error">
        <div class="troubleshoot-q" onclick="toggleTroubleshoot(this)">
          macOS says "SidebotBridge.app can't be opened"
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-a">
          Right-click the app ‚Üí <strong>Open</strong> ‚Üí click Open in the dialog.<br>
          You only need to do this once ‚Äî macOS remembers it.
        </div>
      </div>

      <div class="troubleshoot-item warn">
        <div class="troubleshoot-q" onclick="toggleTroubleshoot(this)">
          Notion search returns no results
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-a">
          Make sure you've shared the Notion page with your integration:<br>
          Open the page in Notion ‚Üí <strong>‚Ä¢‚Ä¢‚Ä¢</strong> menu ‚Üí <strong>Connections</strong> ‚Üí add your integration.
        </div>
      </div>

      <div class="troubleshoot-item info">
        <div class="troubleshoot-q" onclick="toggleTroubleshoot(this)">
          Plugin loads but shows errors in Figma console
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-a">
          Try reloading: in Figma go to Plugins ‚Üí Development ‚Üí <strong>Reload plugin</strong>.<br>
          If it persists, check the Figma console for the specific error.
        </div>
      </div>

      <div class="troubleshoot-item info">
        <div class="troubleshoot-q" onclick="toggleTroubleshoot(this)">
          Claude is not responding to chat
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-a">
          Make sure you have an API key saved in Settings ‚Üí AI API Key.<br>
          The bridge calls Claude directly ‚Äî Claude Desktop does not need to be open.
        </div>
      </div>

      <div class="troubleshoot-item warn">
        <div class="troubleshoot-q" onclick="toggleTroubleshoot(this)">
          Port 3001 already in use
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-a">
          Another process is using the bridge port. Run:<br>
          <code>lsof -ti:3001 | xargs kill</code><br>
          then reopen SidebotBridge.app.
        </div>
      </div>

    </div>
  </div>

  <!-- About -->
  <div class="settings-section">
    <div class="settings-header"><div class="settings-header-left">‚ÑπÔ∏è About</div></div>
    <div class="help-text">
      <strong>Sidebot v1.1</strong> ‚Äî AI-powered PRD validation for Figma<br><br>
      Track requirements, get instant feedback, and catch issues early with Claude Desktop integration.<br><br>
      <strong>Support:</strong> <a href="https://github.com/AnderMagri/Sidebot/issues" target="_blank" style="color:#7B4FBE;">GitHub Issues</a><br>
      <strong>License:</strong> MIT
    </div>
  </div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBOT v1.1 ‚Äî UI Controller
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var currentProject  = null;
var allProjects     = [];
var bridgeSocket    = null;
var bridgeConnected = false;
var notionToken     = '';

// ‚îÄ‚îÄ BRIDGE ‚îÄ‚îÄ
function connectToBridge() {
  // Close any existing socket cleanly before opening a new one
  if (bridgeSocket) {
    bridgeSocket.onclose = null; // prevent the onclose from triggering another retry
    bridgeSocket.close();
    bridgeSocket = null;
  }
  try {
    bridgeSocket = new WebSocket('ws://localhost:3001');

    bridgeSocket.onopen = function() {
      // Don't mark connected yet ‚Äî wait for connection-established from the real bridge
      window._bridgeHandshakeTimeout = setTimeout(function() {
        if (!bridgeConnected && bridgeSocket) bridgeSocket.close();
      }, 3000);
    };

    bridgeSocket.onmessage = function(event) {
      try { handleBridgeMessage(JSON.parse(event.data)); } catch(e) {}
    };

    bridgeSocket.onclose = function() {
      bridgeConnected = false;
      updateConnectionUI(false);
      postToPlugin({ type: 'connect-to-bridge', connected: false });
      setTimeout(connectToBridge, 15000);
    };

    bridgeSocket.onerror = function() {};
  } catch(e) {
    setTimeout(connectToBridge, 15000);
  }
}

function handleBridgeMessage(message) {
  if (message.type === 'connection-established') {
    clearTimeout(window._bridgeHandshakeTimeout);
    bridgeConnected = true;
    updateConnectionUI(true);
    postToPlugin({ type: 'connect-to-bridge', connected: true });
    sendStateToBridge();
    // Forward stored API key to bridge so it can call Claude immediately
    if (window._storedClaudeApiKey && bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
      bridgeSocket.send(JSON.stringify({ type: 'set-api-key', key: window._storedClaudeApiKey }));
    }
    return;
  }

  if (message.type === 'add-goals-from-claude') {
    var existing = allProjects.find(function(p) { return p.name === message.projectName; });
    if (existing) {
      postToPlugin({ type: 'add-goals', projectId: existing.id, goals: message.goals, prdText: message.prdText || '' });
    } else {
      postToPlugin({ type: 'create-project', name: message.projectName });
      window.pendingGoals = { goals: message.goals, prdText: message.prdText || '' };
    }
    alert('‚úÖ Claude added ' + message.goals.length + ' goals to "' + message.projectName + '"!');
  }

  if (message.type === 'add-fixes-from-claude') {
    var proj = allProjects.find(function(p) { return p.name === message.projectName; });
    if (proj) {
      postToPlugin({ type: 'add-fixes', projectId: proj.id, fixes: message.fixes });
      alert('‚úÖ Claude found ' + message.fixes.length + ' issues in "' + message.projectName + '"!');
      setTimeout(function() { document.querySelector('[data-tab="fixes"]').click(); }, 500);
    }
  }

  if (message.type === 'add-edge-cases-from-claude') {
    // Claude returned edge cases ‚Äî create sticky notes on canvas
    var cases     = message.cases || [];
    var frameName = message.frameName || 'Screen';
    if (cases.length) {
      postToPlugin({ type: 'create-edge-cases', cases: cases, frameName: frameName });
    }
  }

  if (message.type === 'chat-response') {
    removeTypingIndicator(window._pendingTypingId);
    window._pendingTypingId = null;
    chatHistory.push({ role: 'assistant', content: message.text });
    addChatBubble('assistant', message.text, message.fixes || []);
  }
}

function sendStateToBridge() {
  if (!bridgeSocket || bridgeSocket.readyState !== WebSocket.OPEN) return;
  bridgeSocket.send(JSON.stringify({ type: 'state-update', projects: allProjects, activeProject: currentProject }));
}

function postToPlugin(msg) {
  parent.postMessage({ pluginMessage: msg }, '*');
}

// ‚îÄ‚îÄ CONNECTION UI UPDATE ‚îÄ‚îÄ
function updateConnectionUI(connected) {
  // Header dot + label
  var dot    = document.getElementById('headerDot');
  var status = document.getElementById('headerStatus');
  dot.style.background    = connected ? '#4ade80' : '#ff6b6b';
  status.textContent      = connected ? 'Claude' : 'Offline';

  // Offline banner
  var banner = document.getElementById('apiBanner');
  banner.classList.toggle('hidden', connected);

  // Ask Claude button
  var btn   = document.getElementById('askClaudeBtn');
  var label = document.getElementById('askClaudeBtnLabel');
  if (connected) {
    btn.className     = 'ask-claude-btn online';
    label.textContent = 'Ask Claude to Add Project';
  } else {
    btn.className     = 'ask-claude-btn offline';
    label.textContent = 'Ask Claude to Add Project ‚Äî Bridge offline';
  }

  // Settings: mode badge
  var badge     = document.getElementById('modeBadge');
  var badgeText = document.getElementById('modeBadgeText');
  if (connected) {
    badge.className   = 'mode-badge online';
    badgeText.textContent = 'Seamless Mode';
  } else {
    badge.className   = 'mode-badge offline';
    badgeText.textContent = 'Manual Mode';
  }

  // Settings: bridge LED
  var bridgeDot     = document.getElementById('bridgeDot');
  var bridgeLedText = document.getElementById('bridgeLedText');
  var bridgeSub     = document.getElementById('bridgeSubText');
  var setupSection  = document.getElementById('bridgeSetupSection');
  bridgeDot.className     = connected ? 'dot2 green' : 'dot2 red';
  bridgeLedText.textContent = connected ? 'Connected' : 'Offline';
  bridgeSub.textContent   = connected ? 'Running on localhost:3001' : 'Not running';
  if (setupSection) setupSection.style.display = connected ? 'none' : 'block';
}

function updateNotionLED(connected, title) {
  var dot     = document.getElementById('notionDot');
  var ledText = document.getElementById('notionLedText');
  var sub     = document.getElementById('notionSubText');
  var chip    = document.getElementById('notionStatusChip');

  if (connected) {
    dot.className         = 'dot2 green';
    ledText.textContent   = 'Connected';
    sub.textContent       = title || 'Token set';
    chip.className        = 'notion-status-chip connected';
    chip.textContent      = title ? ('üìÑ ' + title.slice(0, 18)) : 'Connected';
  } else {
    dot.className         = 'dot2 amber';
    ledText.textContent   = 'Setup needed';
    sub.textContent       = 'Token not set';
    chip.className        = 'notion-status-chip disconnected';
    chip.textContent      = 'Not Connected';
  }
}

function toggleTroubleshoot(qEl) {
  var item = qEl.parentElement;
  var isOpen = item.classList.contains('open');
  // Close all
  document.querySelectorAll('.troubleshoot-item.open').forEach(function(el) { el.classList.remove('open'); });
  // Open this one if it wasn't already open
  if (!isOpen) item.classList.add('open');
}

function refreshStatus() {
  var bridgeDot = document.getElementById('bridgeDot');
  if (bridgeDot) bridgeDot.className = 'dot2 amber';
  bridgeConnected = false;
  connectToBridge(); // always force a fresh connection attempt
}

function goToSettings() {
  document.querySelector('[data-tab="settings"]').click();
}

// ‚îÄ‚îÄ ASK CLAUDE (adds project) ‚îÄ‚îÄ
function askClaude() {
  // Always open the Add Project sheet (works both online and offline).
  // No design data is sent automatically ‚Äî the user controls what to send from inside the sheet.
  openAddProject();
}

// ‚îÄ‚îÄ NOTION ‚îÄ‚îÄ
function openNotionSheet() {
  document.getElementById('notionSheet').classList.add('open');
  if (notionToken) {
    document.getElementById('notionTokenInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + notionToken.slice(-4);
    document.getElementById('notionSearchArea').style.display = 'block';
  }
}

function closeNotionSheet() {
  document.getElementById('notionSheet').classList.remove('open');
}

function saveNotionToken() {
  var raw = document.getElementById('notionTokenInput').value.trim();
  if (!raw || raw.indexOf('‚Ä¢‚Ä¢‚Ä¢‚Ä¢') === 0) return;
  notionToken = raw;
  postToPlugin({ type: 'save-notion-token', token: raw });
  document.getElementById('notionSearchArea').style.display = 'block';
  updateNotionLED(true, null);
}

function searchNotionPages() {
  var q       = document.getElementById('notionSearchInput').value.trim();
  var results = document.getElementById('notionResults');
  results.innerHTML = '<div style="font-size:10px;color:#6b7280;padding:8px;">Searching Notion‚Ä¶</div>';

  fetch('http://localhost:3000/notion/search', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query: q, token: notionToken })
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    if (!data.results || !data.results.length) {
      results.innerHTML = '<div style="font-size:10px;color:#6b7280;text-align:center;padding:12px;">No pages found</div>';
      return;
    }
    results.innerHTML = data.results.slice(0, 8).map(function(page) {
      var title = getNotionTitle(page);
      return '<div class="notion-search-result" onclick="selectNotionPage(\'' + page.id + '\',\'' + title.replace(/'/g,"\\'") + '\')">' +
        '<span style="font-size:16px;">üìÑ</span>' +
        '<div><div style="font-size:11px;font-weight:600;">' + escHtml(title) + '</div>' +
        '<div style="font-size:9px;color:#6b7280;">' + page.id.slice(0,8) + '‚Ä¶</div></div>' +
        '</div>';
    }).join('');
  })
  .catch(function() {
    results.innerHTML = '<div style="font-size:10px;color:#ff6b6b;padding:8px;">‚ö†Ô∏è Bridge not running ‚Äî cannot reach Notion</div>';
  });
}

function getNotionTitle(page) {
  try {
    var props = page.properties;
    var titleProp = props.title || props.Title || props.Name;
    if (!titleProp) {
      var keys = Object.keys(props);
      for (var i = 0; i < keys.length; i++) {
        if (props[keys[i]].type === 'title') { titleProp = props[keys[i]]; break; }
      }
    }
    if (titleProp && titleProp.title) return titleProp.title.map(function(t) { return t.plain_text; }).join('');
    return 'Untitled';
  } catch(e) { return 'Untitled'; }
}

function selectNotionPage(pageId, title) {
  closeNotionSheet();
  fetchAndLoadNotionPRD(pageId, title);
}

function fetchAndLoadNotionPRD(pageId, title) {
  var body = document.getElementById('notionBlockBody');
  body.innerHTML = '<div style="font-size:10px;color:#6b7280;">Loading PRD from Notion‚Ä¶</div>';

  fetch('http://localhost:3000/notion/fetch-blocks', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ blockId: pageId, token: notionToken })
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    var prdText = extractNotionText(data.results || []);
    updateNotionLED(true, title);
    body.innerHTML =
      '<div style="font-size:10px;color:#9ca3af;margin-bottom:6px;">üìÑ <strong style="color:#fff;">' + escHtml(title) + '</strong></div>' +
      '<div style="font-size:9px;color:#6b7280;max-height:50px;overflow:hidden;line-height:1.5;">' + escHtml(prdText.slice(0,180)) + '‚Ä¶</div>' +
      '<button class="btn-primary" style="margin-top:8px;font-size:11px;padding:8px;" onclick="sendPRDToClaude(\'' + pageId + '\',\'' + title.replace(/'/g,"\\'") + '\',\'' + prdText.slice(0,500).replace(/'/g,"\\'").replace(/\n/g,' ') + '\')">ü§ñ Parse with Claude</button>';
  })
  .catch(function() {
    body.innerHTML = '<button class="btn-primary" onclick="openNotionSheet()" style="font-size:11px;padding:8px;">üîó Connect Notion</button>';
    updateNotionLED(false, null);
  });
}

function extractNotionText(blocks) {
  var text = '';
  (blocks || []).forEach(function(b) {
    var type        = b.type;
    var blockContent = b[type];
    if (!blockContent) return;
    var rich = blockContent.rich_text || [];
    var line = rich.map(function(t) { return t.plain_text; }).join('');
    if (line) text += line + '\n';
  });
  return text;
}

function sendPRDToClaude(pageId, title, prdText) {
  if (!bridgeConnected) {
    alert('‚ö†Ô∏è Bridge not connected.\n\nStart SidebotBridge.app first.');
    return;
  }
  bridgeSocket.send(JSON.stringify({
    type: 'prd-data', pageId: pageId, title: title, prdText: prdText,
    projectName: currentProject ? currentProject.name : 'New Project'
  }));
  alert('üì§ PRD sent to Claude! Ask Claude to parse it.');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
postToPlugin({ type: 'load-projects' });
connectToBridge();

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById(tab.dataset.tab + '-content').classList.add('active');
  });
});

// ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  var map = { '1': 'projects', '2': 'fixes', '3': 'goals', '4': 'settings' };
  if (map[e.key]) document.querySelector('[data-tab="' + map[e.key] + '"]').click();
});

// ‚îÄ‚îÄ PROJECT SHEETS ‚îÄ‚îÄ
function openAddProject()  { document.getElementById('addProjectSheet').classList.add('open'); }
function closeAddProject() { document.getElementById('addProjectSheet').classList.remove('open'); }

function copyPrompt() {
  var t = document.getElementById('promptTemplate');
  t.select(); document.execCommand('copy');
  var bg = t.style.background;
  t.style.background = '#1a4a1a';
  setTimeout(function() { t.style.background = bg; }, 200);
}

function importJSON() {
  var raw = document.getElementById('jsonInput').value.trim();
  if (!raw) { alert('Please paste JSON from Claude!'); return; }
  try {
    var data = JSON.parse(raw);
    if (!data.projectName || !Array.isArray(data.goals)) {
      alert('Invalid JSON. Need: {"projectName": "...", "goals": [...]}'); return;
    }
    if (!data.goals.length) { alert('No goals found!'); return; }
    var existing = allProjects.find(function(p) { return p.name === data.projectName; });
    if (existing) {
      if (confirm('Project "' + data.projectName + '" exists. Replace goals with ' + data.goals.length + ' new ones?')) {
        postToPlugin({ type: 'add-goals', projectId: existing.id, goals: data.goals, prdText: data.prdText || '' });
        document.getElementById('jsonInput').value = '';
        selectProject(existing.id);
        setTimeout(function() { document.querySelector('[data-tab="goals"]').click(); }, 100);
      }
    } else {
      postToPlugin({ type: 'create-project', name: data.projectName });
      window.pendingGoals = { goals: data.goals, prdText: data.prdText || '' };
      document.getElementById('jsonInput').value = '';
    }
  } catch(e) { alert('Invalid JSON: ' + e.message); }
}

// ‚îÄ‚îÄ PROJECT ACTIONS ‚îÄ‚îÄ
function selectProject(id) { postToPlugin({ type: 'set-active-project', projectId: id }); }
function deleteProject(id, e) {
  e.stopPropagation();
  if (!confirm('Delete this project?')) return;
  postToPlugin({ type: 'delete-project', projectId: id });
}
function toggleGoal(id) {
  if (!currentProject) return;
  postToPlugin({ type: 'toggle-goal', projectId: currentProject.id, goalId: id });
}
function markFixDone(id) {
  if (!currentProject) return;
  postToPlugin({ type: 'mark-fix-done', projectId: currentProject.id, fixId: id });
}

// ‚îÄ‚îÄ SEND TO CLAUDE ‚îÄ‚îÄ
function sendToClaude(mode) {
  if (!bridgeConnected) { alert('‚ö†Ô∏è Bridge offline.\n\nStart SidebotBridge.app first.'); return; }
  postToPlugin({ type: 'send-to-claude', mode: mode });
}

// ‚îÄ‚îÄ FIXES ACTIONS SHEET (stubs ‚Äî sheet no longer accessible) ‚îÄ‚îÄ
function openFixesActions()  {}
function closeFixesActions() {}

// ‚îÄ‚îÄ CHAT STATE ‚îÄ‚îÄ
var chatHistory = [];

function sendChat() {
  var input = document.getElementById('chatInput');
  var text = input.value.trim();
  if (!text) return;
  if (!bridgeConnected) { alert('‚ö†Ô∏è Bridge offline. Start SidebotBridge.app first.'); return; }
  input.value = '';
  input.style.height = 'auto';
  addChatBubble('user', text);
  chatHistory.push({ role: 'user', content: text });
  window._pendingChatText = text;
  window._pendingChatAction = null;
  window._pendingTypingId = addTypingIndicator();
  postToPlugin({ type: 'get-design-context' });
}

function chatShortcut(action) {
  if (!bridgeConnected) { alert('‚ö†Ô∏è Bridge offline. Start SidebotBridge.app first.'); return; }
  var labels = { grammar: 'Check grammar and spelling', contrast: 'Check color contrast (WCAG AA)', consistency: 'Check design consistency', 'edge-cases': 'List edge cases for this screen' };
  var text = labels[action] || action;
  addChatBubble('user', text);
  chatHistory.push({ role: 'user', content: text });
  window._pendingChatText = text;
  window._pendingChatAction = action;
  window._pendingTypingId = addTypingIndicator();
  postToPlugin({ type: 'get-design-context' });
}

function addChatBubble(role, text, fixes) {
  var empty = document.getElementById('chatEmpty');
  if (empty) empty.style.display = 'none';
  var msgs = document.getElementById('chatMessages');
  var div = document.createElement('div');
  div.className = 'chat-bubble ' + role;
  div.innerHTML = escHtml(text).replace(/\n/g, '<br>');
  if (fixes && fixes.length) {
    fixes.forEach(function(f) {
      var card = document.createElement('div');
      card.className = 'chat-fix-card';
      card.innerHTML = '<div class="fix-issue">‚ö†Ô∏è ' + escHtml(f.issue || f.nodeName) + '</div>' +
        '<div class="fix-detail">' + escHtml(f.suggestion || f.description || '') + '</div>' +
        '<button class="chat-fix-done-btn" onclick="this.textContent=\'Done ‚úì\';this.disabled=true;">Mark as Fixed</button>';
      div.appendChild(card);
    });
  }
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addTypingIndicator() {
  var msgs = document.getElementById('chatMessages');
  var div = document.createElement('div');
  var id = 'typing-' + Date.now();
  div.id = id;
  div.className = 'chat-bubble assistant typing';
  div.textContent = 'Claude is thinking‚Ä¶';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return id;
}

function removeTypingIndicator(id) {
  var el = document.getElementById(id);
  if (el) el.remove();
}

// ‚îÄ‚îÄ CLAUDE API KEY ‚îÄ‚îÄ
function saveClaudeApiKey() {
  var key = document.getElementById('claudeApiInput').value.trim();
  if (!key) return;
  window._storedClaudeApiKey = key;  // keep for reconnect forwarding
  postToPlugin({ type: 'save-claude-api-key', key: key });
  // Forward to bridge immediately if already connected
  if (bridgeConnected && bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
    bridgeSocket.send(JSON.stringify({ type: 'set-api-key', key: key }));
  }
  document.getElementById('claudeApiInput').value = '';
  updateClaudeApiLED(true, key);
}
function deleteClaudeApiKey() {
  if (!confirm('Remove saved Claude API key?')) return;
  postToPlugin({ type: 'delete-claude-api-key' });
  updateClaudeApiLED(false, null);
}
function updateClaudeApiLED(hasKey, key) {
  var dot  = document.getElementById('claudeApiDot');
  var text = document.getElementById('claudeApiLedText');
  var sub  = document.getElementById('claudeApiSub');
  var del  = document.getElementById('claudeApiDeleteBtn');
  if (hasKey) {
    dot.className  = 'dot2 green';
    text.textContent = 'Set';
    sub.textContent  = key ? 'sk-ant-‚Ä¶' + key.slice(-4) : 'Key saved';
    if (del) del.style.display = 'inline-block';
  } else {
    dot.className  = 'dot2 red';
    text.textContent = 'Not set';
    sub.textContent  = 'No key saved';
    if (del) del.style.display = 'none';
  }
}

// ‚îÄ‚îÄ NOTION TOKEN (inline settings) ‚îÄ‚îÄ
function saveNotionTokenInline() {
  var raw = document.getElementById('notionTokenSettingsInput').value.trim();
  if (!raw || raw.indexOf('‚Ä¢‚Ä¢‚Ä¢‚Ä¢') === 0) return;
  notionToken = raw;
  postToPlugin({ type: 'save-notion-token', token: raw });
  document.getElementById('notionTokenSettingsInput').value = '';
  updateNotionLED(true, null);
  var del = document.getElementById('notionDeleteBtn');
  if (del) del.style.display = 'inline-block';
}
function deleteNotionToken() {
  if (!confirm('Remove saved Notion token?')) return;
  notionToken = '';
  postToPlugin({ type: 'save-notion-token', token: '' });
  updateNotionLED(false, null);
  var del = document.getElementById('notionDeleteBtn');
  if (del) del.style.display = 'none';
}

// ‚îÄ‚îÄ GOAL ACTIONS ‚îÄ‚îÄ
var dragSrcGoalId = null;

function editGoal(id) {
  if (!currentProject) return;
  var goal = null;
  for (var i = 0; i < currentProject.goals.length; i++) {
    if (currentProject.goals[i].id === id) { goal = currentProject.goals[i]; break; }
  }
  if (!goal) return;
  var newText = prompt('Edit goal:', goal.text);
  if (newText && newText.trim() && newText.trim() !== goal.text) {
    postToPlugin({ type: 'edit-goal', projectId: currentProject.id, goalId: id, text: newText.trim() });
  }
}

function removeGoal(id, e) {
  if (e) e.stopPropagation();
  if (!currentProject) return;
  if (!confirm('Remove this goal?')) return;
  postToPlugin({ type: 'remove-goal', projectId: currentProject.id, goalId: id });
}

function onGoalDragStart(e, id) {
  dragSrcGoalId = id;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(function() { e.target.classList.add('dragging'); }, 0);
}
function onGoalDragEnd(e) {
  e.target.classList.remove('dragging');
  dragSrcGoalId = null;
  document.querySelectorAll('.goal-item').forEach(function(el) { el.classList.remove('drag-over'); });
}
function onGoalDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}
function onGoalDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}
function onGoalDrop(e, targetId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!dragSrcGoalId || dragSrcGoalId === targetId || !currentProject) return;
  var goals = currentProject.goals.slice();
  var srcIdx = -1, tgtIdx = -1;
  for (var i = 0; i < goals.length; i++) {
    if (goals[i].id === dragSrcGoalId) srcIdx = i;
    if (goals[i].id === targetId)      tgtIdx = i;
  }
  if (srcIdx === -1 || tgtIdx === -1) return;
  var moved = goals.splice(srcIdx, 1)[0];
  goals.splice(tgtIdx, 0, moved);
  postToPlugin({ type: 'reorder-goals', projectId: currentProject.id, goals: goals });
}

// ‚îÄ‚îÄ EDGE CASES (now handled via chatShortcut) ‚îÄ‚îÄ
function checkEdgeCases() { chatShortcut('edge-cases'); }

// ‚îÄ‚îÄ LAYER RENAME ‚îÄ‚îÄ
function renameLayers(type) {
  var btnMap = { 'from-content': 'renameContentBtn', 'clean': 'renameCleanBtn', 'by-type': 'renameTypeBtn', 'number': 'renameNumBtn' };
  var b = document.getElementById(btnMap[type]);
  if (b) b.disabled = true;
  var status = document.getElementById('renameStatus');
  if (status) { status.style.display = 'block'; status.innerHTML = '<span style="color:#6b7280">Renaming‚Ä¶</span>'; }
  postToPlugin({ type: 'rename-layers', renameType: type });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderProjects(projects, activeProject) {
  var list = document.getElementById('projectList');
  if (!projects.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div><div class="empty-text">No projects yet.<br>Create your first one below!</div></div>';
    return;
  }
  list.innerHTML = projects.map(function(p) {
    return '<div class="project-item ' + (p.id === (activeProject && activeProject.id) ? 'active' : '') + '" onclick="selectProject(\'' + p.id + '\')">' +
      '<div class="project-name">' + escHtml(p.name) + '</div>' +
      '<div class="project-stats"><span>' + (p.goals ? p.goals.length : 0) + ' goals</span><span>' + (p.fixes ? p.fixes.length : 0) + ' fixes</span></div>' +
      '<button class="project-delete" onclick="deleteProject(\'' + p.id + '\',event)">Delete</button>' +
    '</div>';
  }).join('');
}

function renderGoals(project) {
  var list  = document.getElementById('goalList');
  var empty = document.getElementById('goalsEmpty');
  var title = document.getElementById('goalsTitle');
  var prog  = document.getElementById('goalsProgress');
  var fill  = document.getElementById('progressFill');

  if (!project) {
    title.textContent = 'No project selected'; prog.textContent = '0/0 complete (0%)';
    fill.style.width = '0%'; list.innerHTML = ''; empty.style.display = 'block'; return;
  }
  title.textContent = project.name;
  if (!project.goals || !project.goals.length) {
    prog.textContent = '0/0 complete (0%)'; fill.style.width = '0%'; list.innerHTML = ''; empty.style.display = 'block'; return;
  }
  empty.style.display = 'none';
  var done  = project.goals.filter(function(g) { return g.status === 'done'; }).length;
  var total = project.goals.length;
  var pct   = Math.round((done / total) * 100);
  prog.textContent = done + '/' + total + ' complete (' + pct + '%)';
  fill.style.width = pct + '%';
  if (pct === 100 && done > 0) setTimeout(triggerConfetti, 300);
  list.innerHTML = project.goals.map(function(g) {
    var id = escHtml(g.id);
    return '<div class="goal-item ' + (g.status === 'done' ? 'done' : '') + '"' +
      ' draggable="true"' +
      ' data-goal-id="' + id + '"' +
      ' ondragstart="onGoalDragStart(event,\'' + id + '\')"' +
      ' ondragend="onGoalDragEnd(event)"' +
      ' ondragover="onGoalDragOver(event)"' +
      ' ondragleave="onGoalDragLeave(event)"' +
      ' ondrop="onGoalDrop(event,\'' + id + '\')">' +
      '<div class="goal-drag-handle" title="Drag to reorder">‚†ø</div>' +
      '<div class="goal-checkbox" onclick="toggleGoal(\'' + id + '\');event.stopPropagation()"></div>' +
      '<div class="goal-text">' + escHtml(g.text) + '</div>' +
      '<div class="goal-hover-actions">' +
        '<button class="goal-action-btn" onclick="editGoal(\'' + id + '\');event.stopPropagation()" title="Edit">‚úèÔ∏è</button>' +
        '<button class="goal-action-btn del" onclick="removeGoal(\'' + id + '\',event)" title="Remove">üóëÔ∏è</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function renderFixes(project) {}

function updateHeader(project) {
  var h = document.getElementById('headerProject');
  if (!project) { h.textContent = 'No project selected'; h.classList.add('empty'); }
  else           { h.textContent = project.name;          h.classList.remove('empty'); }
}

// ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ
function triggerConfetti() {
  var colors = ['purple','yellow','blue','green','pink'];
  for (var i = 0; i < 50; i++) {
    (function(idx) {
      setTimeout(function() {
        var el = document.createElement('div');
        el.className = 'confetti confetti-' + colors[Math.floor(Math.random() * colors.length)];
        el.style.left      = Math.random() * 100 + '%';
        el.style.animation = 'confetti-fall ' + (2 + Math.random() * 2) + 's linear';
        document.body.appendChild(el);
        setTimeout(function() { el.remove(); }, 4000);
      }, idx * 30);
    })(i);
  }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ MESSAGE HANDLER ‚îÄ‚îÄ
window.onmessage = function(event) {
  var msg = event.data.pluginMessage;
  if (!msg) return;

  if (msg.type === 'projects-loaded' || msg.type === 'init-complete') {
    allProjects    = msg.projects || [];
    currentProject = msg.activeProject;
    if (msg.notionToken) {
      notionToken = msg.notionToken;
      updateNotionLED(true, null);
      var del = document.getElementById('notionDeleteBtn');
      if (del) del.style.display = 'inline-block';
    }
    if (msg.claudeApiKey) { window._storedClaudeApiKey = msg.claudeApiKey; updateClaudeApiLED(true, msg.claudeApiKey); }
    renderProjects(allProjects, currentProject);
    renderGoals(currentProject);
    renderFixes(currentProject);
    updateHeader(currentProject);
  }

  if (msg.type === 'project-created') {
    allProjects    = msg.allProjects;
    currentProject = msg.project;
    renderProjects(allProjects, currentProject);
    updateHeader(currentProject);
    closeAddProject();
    if (window.pendingGoals) {
      postToPlugin({ type: 'add-goals', projectId: currentProject.id, goals: window.pendingGoals.goals, prdText: window.pendingGoals.prdText });
      window.pendingGoals = null;
      setTimeout(function() { document.querySelector('[data-tab="goals"]').click(); }, 100);
    }
  }

  if (msg.type === 'project-deleted') {
    allProjects    = msg.allProjects;
    currentProject = allProjects[0] || null;
    renderProjects(allProjects, currentProject);
    renderGoals(currentProject);
    renderFixes(currentProject);
    updateHeader(currentProject);
  }

  if (msg.type === 'active-project-changed') {
    currentProject = msg.project;
    renderProjects(allProjects, currentProject);
    renderGoals(currentProject);
    renderFixes(currentProject);
    updateHeader(currentProject);
  }

  if (msg.type === 'goals-updated') {
    var idx = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
    if (idx !== -1) allProjects[idx] = msg.project;
    if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
    renderGoals(currentProject); renderProjects(allProjects, currentProject);
  }

  if (msg.type === 'goal-toggled') {
    var idx2 = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
    if (idx2 !== -1) allProjects[idx2] = msg.project;
    if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
    renderGoals(currentProject);
  }

  if (msg.type === 'fixes-updated') {
    var idx3 = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
    if (idx3 !== -1) allProjects[idx3] = msg.project;
    if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
    renderFixes(currentProject); renderProjects(allProjects, currentProject);
  }

  if (msg.type === 'fix-marked-done') {
    var idx4 = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
    if (idx4 !== -1) allProjects[idx4] = msg.project;
    if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
    renderFixes(currentProject);
  }

  if (msg.type === 'notion-token-saved') { updateNotionLED(true, null); }

  if (msg.type === 'bridge-status') { updateConnectionUI(msg.connected); }

  if (msg.type === 'edge-cases-created') {
    alert('üß™ ' + msg.count + ' edge cases added as sticky notes on the canvas!');
  }

  if (msg.type === 'claude-data-ready') {
    if (bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
      bridgeSocket.send(JSON.stringify({
        type: 'design-data',
        data: { mode: msg.mode, pageName: msg.pageName, fileKey: msg.fileKey, nodes: msg.data,
                projectName: currentProject ? currentProject.name : 'Unknown' }
      }));
      alert('üì§ Design sent to Claude!\n\nNow tell Claude:\n"Review my design against the PRD"');
    } else {
      alert('‚ö†Ô∏è Bridge not connected.\n\nStart SidebotBridge.app first.');
    }
  }

  if (msg.type === 'state-for-bridge') {
    if (bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
      bridgeSocket.send(JSON.stringify({ type: 'state-update', projects: msg.projects, activeProject: msg.activeProject }));
    }
  }

  if (msg.type === 'design-context-ready') {
    if (window._pendingChatText && bridgeConnected && bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
      bridgeSocket.send(JSON.stringify({
        type: 'chat-message',
        text: window._pendingChatText,
        action: window._pendingChatAction || null,
        history: chatHistory.slice(-10),
        designData: msg.data
      }));
    }
    window._pendingChatText = null;
    window._pendingChatAction = null;
  }

  if (msg.type === 'rename-done') {
    ['renameContentBtn','renameCleanBtn','renameTypeBtn','renameNumBtn'].forEach(function(id) {
      var b = document.getElementById(id); if (b) b.disabled = false;
    });
    var status = document.getElementById('renameStatus');
    if (!status) return;
    var html = '';
    if (msg.count > 0) {
      html = '<div style="color:#4ade80;font-weight:600;">‚úì Renamed ' + msg.count + ' layer' + (msg.count !== 1 ? 's' : '') + '</div>';
      (msg.renamedList || []).forEach(function(r) {
        html += '<div style="font-size:9px;margin-top:2px;font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' +
          '<span style="color:#ff6b6b">' + escHtml(r.from) + '</span>' +
          '<span style="color:#6b7280"> ‚Üí </span>' +
          '<span style="color:#4ade80">' + escHtml(r.to) + '</span></div>';
      });
      if ((msg.renamedList || []).length < msg.count) {
        html += '<div style="color:#6b7280;font-size:9px;">‚Ä¶and ' + (msg.count - msg.renamedList.length) + ' more</div>';
      }
    } else {
      html = '<div style="color:#6b7280;">' + (msg.error ? '‚ö†Ô∏è ' + escHtml(msg.error) : '‚ö†Ô∏è No changes ‚Äî names already match') + '</div>';
    }
    status.style.display = 'block';
    status.innerHTML = html;
    setTimeout(function() { status.style.display = 'none'; status.innerHTML = ''; }, 6000);
  }
};
</script>

</body>
</html>
