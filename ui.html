<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sidebot</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: #1a1a1a;
  color: #fff;
  overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header {
  background: #2a2a2a;
  padding: 16px;
  border-bottom: 1px solid #3a3a3a;
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4ade80;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.header-badges {
  display: flex;
  align-items: center;
  gap: 6px;
}

.beta-badge {
  background: #fbbf24;
  color: #000;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.project-title {
  font-size: 13px;
  opacity: 0.9;
  font-weight: 600;
  color: #fff;
}

.project-title.empty {
  opacity: 0.5;
  font-style: italic;
  font-size: 11px;
}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs {
  display: flex;
  background: #2a2a2a;
  border-bottom: 1px solid #3a3a3a;
}

.tab {
  flex: 1;
  padding: 10px 8px;
  font-size: 11px;
  text-align: center;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  opacity: 0.6;
}

.tab:hover { opacity: 0.9; background: #333; }
.tab.active { opacity: 1; border-bottom-color: #7B4FBE; background: #333; }

/* ‚îÄ‚îÄ‚îÄ TAB CONTENT ‚îÄ‚îÄ‚îÄ */
.tab-content {
  display: none;
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 16px;
}

.tab-content.active { display: block; }

/* ‚îÄ‚îÄ‚îÄ NOTION BLOCK ‚îÄ‚îÄ‚îÄ */
.notion-block {
  background: #1e2538;
  border: 1px solid #2d3a5a;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 12px;
}

.notion-block-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: #1a2033;
  border-bottom: 1px solid #2d3a5a;
}

.notion-block-title {
  font-size: 11px;
  font-weight: 700;
  color: #60a5fa;
  display: flex;
  align-items: center;
  gap: 6px;
}

.notion-block-body {
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.notion-status-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.notion-status-chip.connected {
  background: #1a3d1a;
  border: 1px solid #2a5a2a;
  color: #4ade80;
}

.notion-status-chip.disconnected {
  background: #2d1a3d;
  border: 1px solid #4a2a5a;
  color: #a78bfa;
}

.notion-search-result {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: #2a2a3a;
  border: 1px solid #3a3a5a;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.notion-search-result:hover {
  border-color: #60a5fa;
  background: #1e2538;
}

/* ‚îÄ‚îÄ‚îÄ PROJECTS TAB ‚îÄ‚îÄ‚îÄ */
.project-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.project-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.project-item:hover {
  border-color: #7B4FBE;
  background: #333;
}

.project-item.active {
  border-color: #7B4FBE;
  background: #333;
}

.project-name {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 4px;
}

.project-stats {
  font-size: 10px;
  opacity: 0.6;
  display: flex;
  gap: 12px;
}

.project-delete {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #3a3a3a;
  border: none;
  color: #ff6b6b;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 10px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}

.project-item:hover .project-delete {
  opacity: 1;
}

.project-delete:hover {
  background: #ff6b6b;
  color: #fff;
}

.new-project-section {
  background: #2a2a2a;
  border: 2px dashed #3a3a3a;
  border-radius: 6px;
  padding: 16px;
}

.btn-add-project {
  width: 100%;
  padding: 14px;
  background: #2a2a2a;
  border: 2px dashed #7B4FBE;
  border-radius: 6px;
  color: #7B4FBE;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 12px;
}

.btn-add-project:hover {
  background: #333;
  border-color: #9b6fde;
  color: #9b6fde;
}

/* ‚îÄ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ‚îÄ */
.bottom-sheet {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  display: none;
}

.bottom-sheet.open {
  display: block;
}

.bottom-sheet-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  animation: fadeIn 0.2s;
}

.bottom-sheet-content {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 80%;
  background: #1a1a1a;
  border-radius: 12px 12px 0 0;
  animation: slideUp 0.3s;
  overflow-y: auto;
}

.sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #3a3a3a;
  position: sticky;
  top: 0;
  background: #1a1a1a;
  z-index: 1;
}

.sheet-title {
  font-size: 14px;
  font-weight: 600;
}

.sheet-close {
  background: #2a2a2a;
  border: none;
  color: #fff;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.sheet-close:hover {
  background: #3a3a3a;
}

.sheet-body {
  padding: 16px;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.new-project-section input {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 12px;
  margin-bottom: 8px;
}

.btn-primary {
  width: 100%;
  padding: 10px;
  background: #7B4FBE;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary:hover {
  background: #6a3fa8;
}

.btn-success {
  width: 100%;
  padding: 10px;
  background: #4ade80;
  color: #000;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-success:hover {
  background: #3ac970;
}

.btn-secondary {
  padding: 10px;
  background: #2a2a2a;
  border: 1px solid #7B4FBE;
  color: #fff;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  background: #7B4FBE;
  border-color: #7B4FBE;
}

.send-claude-section {
  margin-bottom: 16px;
  padding: 12px;
  background: #2a2a2a;
  border-radius: 6px;
  border: 1px solid #3a3a3a;
}

.import-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #3a3a3a;
}

.section-title {
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.section-desc {
  font-size: 10px;
  opacity: 0.6;
  margin-bottom: 8px;
  line-height: 1.4;
}

textarea {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 10px;
  font-family: monospace;
  resize: vertical;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ‚îÄ GOALS TAB ‚îÄ‚îÄ‚îÄ */
.goals-header {
  text-align: center;
  margin-bottom: 20px;
}

.goals-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
}

.goals-progress {
  font-size: 11px;
  opacity: 0.7;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #2a2a2a;
  border-radius: 3px;
  overflow: hidden;
  margin-top: 8px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #7B4FBE, #9b6fde);
  transition: width 0.3s;
}

.goal-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.goal-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.goal-item:hover {
  background: #333;
}

.goal-checkbox {
  width: 18px;
  height: 18px;
  border: 2px solid #3a3a3a;
  border-radius: 4px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  margin-top: 2px;
}

.goal-item.done .goal-checkbox {
  background: #7B4FBE;
  border-color: #7B4FBE;
}

.goal-item.done .goal-checkbox::after {
  content: '‚úì';
  color: #fff;
  font-size: 12px;
  font-weight: 700;
}

.goal-text {
  flex: 1;
  font-size: 12px;
  line-height: 1.5;
}

.goal-item.done .goal-text {
  opacity: 0.5;
  text-decoration: line-through;
}

/* ‚îÄ‚îÄ‚îÄ FIXES TAB ‚îÄ‚îÄ‚îÄ */
.fix-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.fix-item {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-left: 3px solid #ff6b6b;
  border-radius: 6px;
  padding: 12px;
}

.fix-item.done {
  border-left-color: #4ade80;
  opacity: 0.6;
}

.fix-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.fix-title {
  font-size: 12px;
  font-weight: 600;
  color: #ff6b6b;
}

.fix-item.done .fix-title {
  color: #4ade80;
}

.fix-description {
  font-size: 11px;
  line-height: 1.5;
  margin-bottom: 10px;
  opacity: 0.8;
}

.fix-actions {
  display: flex;
  gap: 6px;
}

.fix-btn {
  flex: 1;
  padding: 6px 10px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.fix-btn.done-btn {
  background: #4ade80;
  color: #000;
}

.fix-btn.done-btn:hover {
  background: #3ac970;
}

.fix-btn.done-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  opacity: 0.5;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.empty-text {
  font-size: 12px;
  line-height: 1.6;
}

/* ‚îÄ‚îÄ‚îÄ SETTINGS TAB ‚îÄ‚îÄ‚îÄ */
.settings-section {
  margin-bottom: 24px;
}

.settings-header {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.settings-description {
  font-size: 10px;
  opacity: 0.6;
  margin-bottom: 12px;
  line-height: 1.5;
}

.status-connected {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: #1a3d1a;
  border: 1px solid #2a5a2a;
  border-radius: 4px;
  font-size: 11px;
}

.status-card {
  padding: 12px;
  border-radius: 6px;
  font-size: 11px;
  line-height: 1.6;
  margin-bottom: 12px;
}

.status-card.connected {
  background: #1a3d1a;
  border: 1px solid #2a5a2a;
  color: #4ade80;
}

.status-card.disconnected {
  background: #3d1a1a;
  border: 1px solid #5a2a2a;
  color: #ff6b6b;
}

.btn-download {
  display: block;
  width: 100%;
  padding: 12px;
  background: #7B4FBE;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  text-decoration: none;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 12px;
  transition: all 0.2s;
}

.btn-download:hover {
  background: #6a3fa8;
  transform: translateY(-1px);
}

.help-text {
  font-size: 10px;
  opacity: 0.5;
  line-height: 1.5;
  margin-top: 8px;
}

.keyboard-shortcuts {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px;
  font-size: 10px;
  padding: 12px;
  background: #2a2a2a;
  border-radius: 4px;
}

.key {
  background: #1a1a1a;
  padding: 4px 8px;
  border-radius: 3px;
  font-weight: 600;
  text-align: center;
  min-width: 24px;
}

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
.tab-content::-webkit-scrollbar {
  width: 6px;
}

.tab-content::-webkit-scrollbar-track {
  background: #1a1a1a;
}

.tab-content::-webkit-scrollbar-thumb {
  background: #3a3a3a;
  border-radius: 3px;
}

.tab-content::-webkit-scrollbar-thumb:hover {
  background: #4a4a4a;
}

/* ‚îÄ‚îÄ‚îÄ FIXES ACTION BUTTONS ‚îÄ‚îÄ‚îÄ */
.fixes-actions-section {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 16px;
  margin-bottom: 16px;
}

.action-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 14px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.action-btn:hover {
  background: #333;
  border-color: #7B4FBE;
  transform: translateY(-1px);
}

.action-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.action-btn-primary {
  grid-column: 1 / -1;
  background: #7B4FBE;
  border-color: #7B4FBE;
}

.action-btn-primary:hover {
  background: #6a3fa8;
}

.action-icon {
  font-size: 16px;
}

.action-label {
  flex: 1;
}

/* ‚îÄ‚îÄ‚îÄ RENAME STATUS ‚îÄ‚îÄ‚îÄ */
.rename-status {
  margin-top: 10px;
  font-size: 10px;
  line-height: 1.6;
  display: none;
}

/* ‚îÄ‚îÄ‚îÄ CONFETTI ANIMATION ‚îÄ‚îÄ‚îÄ */
@keyframes confetti-fall {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg);
    opacity: 0;
  }
}

.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 9999;
  pointer-events: none;
}

.confetti-purple { background: #7B4FBE; }
.confetti-yellow { background: #fbbf24; }
.confetti-blue { background: #3b82f6; }
.confetti-green { background: #10b981; }
.confetti-pink { background: #ec4899; }

/* ‚îÄ‚îÄ‚îÄ NOTION SHEET INPUT ‚îÄ‚îÄ‚îÄ */
.notion-input {
  width: 100%;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #fff;
  font-size: 12px;
  margin-bottom: 8px;
}

.notion-input:focus {
  outline: none;
  border-color: #60a5fa;
}

</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <div class="connection-status">
      <div class="status-dot"></div>
      <span>Claude</span>
    </div>
    <div class="header-badges">
      <div class="beta-badge">BETA</div>
      <div class="beta-badge">v1.1</div>
    </div>
  </div>
  <div class="project-title empty" id="headerProject">No project selected</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="projects">üìÅ Projects</div>
  <div class="tab" data-tab="fixes">üîß Fixes</div>
  <div class="tab" data-tab="goals">üéØ Goals</div>
  <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
</div>

<!-- Projects Tab -->
<div class="tab-content active" id="projects-content">

  <!-- Notion PRD Block -->
  <div class="notion-block" id="notionBlock">
    <div class="notion-block-header">
      <div class="notion-block-title">
        üìù Notion PRD
      </div>
      <div class="notion-status-chip disconnected" id="notionStatusChip">Not Connected</div>
    </div>
    <div class="notion-block-body" id="notionBlockBody">
      <button class="btn-primary" onclick="openNotionSheet()" style="font-size:11px;padding:8px;">
        üîó Connect Notion
      </button>
    </div>
  </div>

  <div class="project-list" id="projectList"></div>

  <button class="btn-add-project" onclick="openAddProject()">+ Add New Project</button>
</div>

<!-- Add Project Bottom Sheet -->
<div class="bottom-sheet" id="addProjectSheet">
  <div class="bottom-sheet-overlay" onclick="closeAddProject()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">üìã Add New Project</div>
      <button class="sheet-close" onclick="closeAddProject()">‚úï</button>
    </div>

    <div class="sheet-body">
      <div class="section-desc">
        1. Copy this prompt and paste in Claude Desktop with your PRD:
      </div>
      <textarea id="promptTemplate" readonly rows="3" onclick="copyPrompt()" style="margin-bottom: 12px; opacity: 0.8; cursor: pointer; background: #2a2a2a; font-size: 10px;">Analyze this PRD and create JSON for Sidebot:

[Paste your PRD here]

Return format: {"projectName": "...", "goals": ["...", "..."]}</textarea>

      <div class="section-desc" style="margin-top: 12px;">
        2. Paste Claude's JSON response here:
      </div>
      <textarea id="jsonInput" rows="4" placeholder='{"projectName": "My Project", "goals": ["Goal 1", "Goal 2"]}' style="font-size: 11px;"></textarea>
      <button class="btn-success" onclick="importJSON()">‚ú® Import Project + Goals</button>
    </div>
  </div>
</div>

<!-- Notion Bottom Sheet -->
<div class="bottom-sheet" id="notionSheet">
  <div class="bottom-sheet-overlay" onclick="closeNotionSheet()"></div>
  <div class="bottom-sheet-content">
    <div class="sheet-header">
      <div class="sheet-title">üìù Connect Notion PRD</div>
      <button class="sheet-close" onclick="closeNotionSheet()">‚úï</button>
    </div>
    <div class="sheet-body">
      <div class="section-desc" style="line-height:1.6;">
        Create an integration token at <strong style="color:#fff;">notion.so/my-integrations</strong>, then share your PRD page with it.
      </div>
      <input type="password" class="notion-input" id="notionTokenInput" placeholder="secret_xxxxxxxxxxxxx" autocomplete="off">
      <button class="btn-primary" onclick="saveNotionToken()">Save Token</button>

      <div id="notionSearchArea" style="display:none;margin-top:16px;border-top:1px solid #3a3a3a;padding-top:16px;">
        <div class="section-title">Search PRD Pages</div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input type="text" class="notion-input" id="notionSearchInput" placeholder="Search pages‚Ä¶" style="flex:1;margin-bottom:0;">
          <button class="btn-secondary" onclick="searchNotionPages()" style="white-space:nowrap;">Search</button>
        </div>
        <div id="notionResults"></div>
      </div>
    </div>
  </div>
</div>

<!-- Goals Tab -->
<div class="tab-content" id="goals-content">
  <div class="goals-header">
    <div class="goals-title" id="goalsTitle">No project selected</div>
    <div class="goals-progress">
      <span id="goalsProgress">0/0 complete (0%)</span>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="send-claude-section">
    <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; opacity: 0.7;">üì§ Send to Claude for Review</div>
    <div style="display: flex; gap: 8px;">
      <button class="btn-secondary" onclick="sendToClaude('selection')" style="flex: 1;">
        üìç Selection
      </button>
      <button class="btn-secondary" onclick="sendToClaude('page')" style="flex: 1;">
        üìÑ Current Page
      </button>
    </div>
  </div>

  <div class="goal-list" id="goalList"></div>

  <div class="empty-state" id="goalsEmpty">
    <div class="empty-icon">üéØ</div>
    <div class="empty-text">
      No goals yet.<br>
      Add a project with goals to track progress.
    </div>
  </div>
</div>

<!-- Fixes Tab -->
<div class="tab-content" id="fixes-content">

  <!-- Quick Actions -->
  <div class="fixes-actions-section">
    <div class="section-title">üîç Quick Actions</div>
    <div class="section-desc">Select a frame, then click an action below</div>

    <div class="action-buttons">
      <button class="action-btn" onclick="checkGrammar()">
        <span class="action-icon">üî§</span>
        <span class="action-label">Check Grammar</span>
      </button>

      <button class="action-btn" onclick="checkAutoLayout()">
        <span class="action-icon">üìê</span>
        <span class="action-label">Auto-layout</span>
      </button>

      <button class="action-btn" onclick="checkContrast()">
        <span class="action-icon">üé®</span>
        <span class="action-label">Contrast</span>
      </button>

      <button class="action-btn action-btn-primary" onclick="generalReview()">
        <span class="action-icon">üìã</span>
        <span class="action-label">Full Review</span>
      </button>
    </div>
  </div>

  <!-- Layer / Rename Tools -->
  <div class="fixes-actions-section">
    <div class="section-title">‚úèÔ∏è Layer Tools</div>
    <div class="section-desc">Renames layers in selection (or full page if nothing selected)</div>

    <div class="action-buttons">
      <button class="action-btn" id="renameContentBtn" onclick="renameLayers('from-content')">
        <span class="action-icon">üìù</span>
        <span class="action-label">From Content</span>
      </button>

      <button class="action-btn" id="renameCleanBtn" onclick="renameLayers('clean')">
        <span class="action-icon">üßπ</span>
        <span class="action-label">Clean Names</span>
      </button>

      <button class="action-btn" id="renameTypeBtn" onclick="renameLayers('by-type')">
        <span class="action-icon">üè∑Ô∏è</span>
        <span class="action-label">By Type</span>
      </button>

      <button class="action-btn" id="renameNumBtn" onclick="renameLayers('number')">
        <span class="action-icon">üî¢</span>
        <span class="action-label">Add Numbers</span>
      </button>
    </div>

    <div class="rename-status" id="renameStatus"></div>
  </div>

  <!-- Fixes List -->
  <div class="fixes-list-section">
    <div class="section-title" style="margin-top: 4px;">üìù Issues Found</div>
    <div class="fix-list" id="fixList"></div>

    <div class="empty-state" id="fixesEmpty">
      <div class="empty-icon">‚úÖ</div>
      <div class="empty-text">
        No issues found yet.<br>
        Use quick actions above or ask Claude to review.
      </div>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div class="tab-content" id="settings-content">
  <div class="settings-section">
    <div class="settings-header">üîó Connection Status</div>
    <div class="settings-description">
      Sidebot works in two modes:
    </div>
    <div id="bridgeStatusCard" class="status-card"></div>
  </div>

  <div class="settings-section" id="bridgeSetupSection">
    <div class="settings-header">‚ö° Enable Seamless Mode</div>
    <div class="settings-description">
      Download the free Bridge app for automatic sync with Claude Desktop.
    </div>
    <a href="https://github.com/AnderMagri/Sidebot/releases/latest" target="_blank" class="btn-download">
      üì• Download SidebotBridge.app
    </a>
    <div class="help-text">
      <strong>Quick Setup:</strong><br>
      1. Download SidebotBridge.zip from GitHub Releases<br>
      2. Unzip and open <strong>SidebotBridge.app</strong> (Mac)<br>
      &nbsp;&nbsp;&nbsp;(Right-click ‚Üí Open if macOS blocks it)<br>
      3. Plugin auto-connects! üü¢<br><br>

      <strong>Or use Manual Mode</strong> ‚Äî No installation needed!
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-header">‚å®Ô∏è Keyboard Shortcuts</div>
    <div class="keyboard-shortcuts">
      <span class="key">1</span> <span>Projects</span>
      <span class="key">2</span> <span>Fixes</span>
      <span class="key">3</span> <span>Goals</span>
      <span class="key">4</span> <span>Settings</span>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-header">üîå Figma Desktop Bridge (Optional)</div>
    <div class="settings-description">
      For advanced users: Enable direct file reading by Claude
    </div>
    <div class="help-text">
      <strong>What it does:</strong><br>
      Allows Claude to read your Figma files directly without copy/paste<br><br>

      <strong>How to install:</strong><br>
      1. Open Claude Desktop ‚Üí Settings ‚Üí Connectors<br>
      2. Find "Figma" and click Connect<br>
      3. In Figma: Right-click ‚Üí Plugins ‚Üí Development ‚Üí Figma Desktop Bridge<br>
      4. Click Run<br><br>

      <strong>When enabled, Claude can:</strong><br>
      ‚Ä¢ Read your designs automatically<br>
      ‚Ä¢ Analyze multiple frames at once<br>
      ‚Ä¢ Check consistency across screens<br><br>

      ‚ö†Ô∏è This is separate from the Sidebot Bridge app
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-header">‚ÑπÔ∏è About</div>
    <div class="help-text">
      <strong>Sidebot v1.1</strong><br>
      AI-powered PRD validation for Figma<br><br>

      Track requirements, get instant feedback, and catch issues early with Claude Desktop integration.<br><br>

      <strong>Support:</strong> GitHub Issues<br>
      <strong>License:</strong> MIT
    </div>
  </div>
</div>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SIDEBOT v1.1 ‚Äî UI with Bridge + Notion PRD
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let currentProject = null;
  let allProjects = [];
  let bridgeSocket = null;
  let bridgeConnected = false;
  let notionToken = '';

  // ‚îÄ‚îÄ‚îÄ CONNECT TO BRIDGE SERVER ‚îÄ‚îÄ‚îÄ
  function connectToBridge() {
    try {
      bridgeSocket = new WebSocket('ws://localhost:3001');

      bridgeSocket.onopen = function() {
        console.log('üü¢ Connected to bridge server');
        bridgeConnected = true;
        updateConnectionIndicator(true);

        parent.postMessage({
          pluginMessage: { type: 'connect-to-bridge', connected: true }
        }, '*');

        sendStateToBridge();
      };

      bridgeSocket.onmessage = function(event) {
        try {
          var message = JSON.parse(event.data);
          handleBridgeMessage(message);
        } catch (e) {
          console.error('Error parsing bridge message:', e);
        }
      };

      bridgeSocket.onclose = function() {
        console.log('üî¥ Bridge disconnected');
        bridgeConnected = false;
        updateConnectionIndicator(false);

        parent.postMessage({
          pluginMessage: { type: 'connect-to-bridge', connected: false }
        }, '*');

        setTimeout(connectToBridge, 3000);
      };

      bridgeSocket.onerror = function(error) {
        console.error('Bridge connection error:', error);
      };

    } catch (e) {
      console.error('Failed to connect to bridge:', e);
      setTimeout(connectToBridge, 3000);
    }
  }

  // ‚îÄ‚îÄ‚îÄ HANDLE MESSAGES FROM BRIDGE ‚îÄ‚îÄ‚îÄ
  function handleBridgeMessage(message) {
    if (message.type === 'connection-established') {
      console.log('‚úÖ Bridge confirmed connection');
    }

    if (message.type === 'add-goals-from-claude') {
      var existing = allProjects.find(function(p) { return p.name === message.projectName; });

      if (existing) {
        parent.postMessage({
          pluginMessage: {
            type: 'add-goals',
            projectId: existing.id,
            goals: message.goals,
            prdText: message.prdText || ''
          }
        }, '*');
      } else {
        parent.postMessage({
          pluginMessage: { type: 'create-project', name: message.projectName }
        }, '*');
        window.pendingGoals = { goals: message.goals, prdText: message.prdText || '' };
      }

      alert('‚úÖ Claude added ' + message.goals.length + ' goals to "' + message.projectName + '"!');
    }

    if (message.type === 'add-fixes-from-claude') {
      var existingProj = allProjects.find(function(p) { return p.name === message.projectName; });

      if (existingProj) {
        parent.postMessage({
          pluginMessage: {
            type: 'add-fixes',
            projectId: existingProj.id,
            fixes: message.fixes
          }
        }, '*');

        alert('‚úÖ Claude found ' + message.fixes.length + ' issues in "' + message.projectName + '"!');

        setTimeout(function() {
          document.querySelector('[data-tab="fixes"]').click();
        }, 500);
      }
    }
  }

  // ‚îÄ‚îÄ‚îÄ SEND STATE TO BRIDGE ‚îÄ‚îÄ‚îÄ
  function sendStateToBridge() {
    if (!bridgeSocket || bridgeSocket.readyState !== WebSocket.OPEN) return;
    bridgeSocket.send(JSON.stringify({
      type: 'state-update',
      projects: allProjects,
      activeProject: currentProject
    }));
  }

  // ‚îÄ‚îÄ‚îÄ UPDATE CONNECTION INDICATOR ‚îÄ‚îÄ‚îÄ
  function updateConnectionIndicator(connected) {
    var dot = document.querySelector('.status-dot');
    var text = document.querySelector('.connection-status span');

    if (connected) {
      dot.style.background = '#4ade80';
      text.textContent = 'Claude';
    } else {
      dot.style.background = '#ff6b6b';
      text.textContent = 'Offline';
    }

    updateSettingsStatus(connected);
  }

  // ‚îÄ‚îÄ‚îÄ UPDATE SETTINGS STATUS CARD ‚îÄ‚îÄ‚îÄ
  function updateSettingsStatus(connected) {
    var card = document.getElementById('bridgeStatusCard');
    var setupSection = document.getElementById('bridgeSetupSection');

    if (connected) {
      card.className = 'status-card connected';
      card.innerHTML = '<strong>üü¢ Seamless Mode Active</strong><br>Bridge connected! Talk to Claude naturally ‚Äî everything syncs automatically.';
      setupSection.style.display = 'none';
    } else {
      card.className = 'status-card disconnected';
      card.innerHTML = '<strong>üî¥ Manual Mode</strong><br>Copy/paste JSON workflow. Or download SidebotBridge.app below for seamless integration.';
      setupSection.style.display = 'block';
    }
  }

  // ‚îÄ‚îÄ‚îÄ NOTION ‚îÄ‚îÄ‚îÄ
  function openNotionSheet() {
    var sheet = document.getElementById('notionSheet');
    sheet.classList.add('open');
    if (notionToken) {
      var inp = document.getElementById('notionTokenInput');
      inp.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + notionToken.slice(-4);
      document.getElementById('notionSearchArea').style.display = 'block';
    }
  }

  function closeNotionSheet() {
    document.getElementById('notionSheet').classList.remove('open');
  }

  function saveNotionToken() {
    var raw = document.getElementById('notionTokenInput').value.trim();
    if (!raw || raw.indexOf('‚Ä¢‚Ä¢‚Ä¢‚Ä¢') === 0) return;
    notionToken = raw;
    parent.postMessage({ pluginMessage: { type: 'save-notion-token', token: raw } }, '*');
    document.getElementById('notionSearchArea').style.display = 'block';
    updateNotionStatus(true, null);
  }

  function searchNotionPages() {
    var q = document.getElementById('notionSearchInput').value.trim();
    var results = document.getElementById('notionResults');
    results.innerHTML = '<div style="font-size:10px;color:#6b7280;padding:8px;">Searching Notion‚Ä¶</div>';

    fetch('http://localhost:3000/notion/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: q, token: notionToken })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (!data.results || data.results.length === 0) {
        results.innerHTML = '<div style="font-size:10px;color:#6b7280;text-align:center;padding:12px;">No pages found</div>';
        return;
      }
      results.innerHTML = data.results.slice(0, 8).map(function(page) {
        var title = getNotionTitle(page);
        return '<div class="notion-search-result" onclick="selectNotionPage(\'' + page.id + '\',\'' + title.replace(/'/g, "\\'") + '\')">' +
          '<span style="font-size:16px;">üìÑ</span>' +
          '<div><div style="font-size:11px;font-weight:600;">' + escHtml(title) + '</div>' +
          '<div style="font-size:9px;color:#6b7280;">' + page.id.slice(0,8) + '‚Ä¶</div></div>' +
          '</div>';
      }).join('');
    })
    .catch(function() {
      results.innerHTML = '<div style="font-size:10px;color:#ff6b6b;padding:8px;">‚ö†Ô∏è Bridge not running ‚Äî cannot reach Notion</div>';
    });
  }

  function getNotionTitle(page) {
    try {
      var props = page.properties;
      var titleProp = props.title || props.Title || props.Name;
      if (!titleProp) {
        var keys = Object.keys(props);
        for (var i = 0; i < keys.length; i++) {
          if (props[keys[i]].type === 'title') { titleProp = props[keys[i]]; break; }
        }
      }
      if (titleProp && titleProp.title) return titleProp.title.map(function(t) { return t.plain_text; }).join('');
      return 'Untitled';
    } catch(e) { return 'Untitled'; }
  }

  function selectNotionPage(pageId, title) {
    closeNotionSheet();
    fetchAndLoadNotionPRD(pageId, title);
  }

  function fetchAndLoadNotionPRD(pageId, title) {
    var body = document.getElementById('notionBlockBody');
    body.innerHTML = '<div style="font-size:10px;color:#6b7280;">Loading PRD from Notion‚Ä¶</div>';

    fetch('http://localhost:3000/notion/fetch-blocks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ blockId: pageId, token: notionToken })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      var prdText = extractNotionText(data.results || []);
      updateNotionStatus(true, title);
      body.innerHTML =
        '<div style="font-size:10px;color:#9ca3af;margin-bottom:6px;">üìÑ <strong style="color:#fff;">' + escHtml(title) + '</strong></div>' +
        '<div style="font-size:9px;color:#6b7280;max-height:50px;overflow:hidden;line-height:1.5;">' + escHtml(prdText.slice(0,180)) + '‚Ä¶</div>' +
        '<button class="btn-primary" style="margin-top:8px;font-size:11px;padding:8px;" onclick="sendPRDToClaude(\'' + pageId + '\',\'' + title.replace(/'/g,"\\'") + '\',\'' + prdText.slice(0,500).replace(/'/g,"\\'").replace(/\n/g,' ') + '\')">ü§ñ Parse with Claude</button>';
    })
    .catch(function() {
      body.innerHTML = '<button class="btn-primary" onclick="openNotionSheet()" style="font-size:11px;padding:8px;">üîó Connect Notion</button>';
      updateNotionStatus(false, null);
    });
  }

  function extractNotionText(blocks) {
    var text = '';
    (blocks || []).forEach(function(b) {
      var type = b.type;
      var blockContent = b[type];
      if (!blockContent) return;
      var rich = blockContent.rich_text || [];
      var line = rich.map(function(t) { return t.plain_text; }).join('');
      if (line) text += line + '\n';
    });
    return text;
  }

  function sendPRDToClaude(pageId, title, prdText) {
    if (!bridgeConnected) {
      alert('‚ö†Ô∏è Bridge not connected.\n\nStart SidebotBridge.app first.');
      return;
    }
    bridgeSocket.send(JSON.stringify({
      type: 'prd-data',
      pageId: pageId,
      title: title,
      prdText: prdText,
      projectName: currentProject ? currentProject.name : 'New Project'
    }));
    alert('üì§ PRD sent to Claude! Ask Claude to parse it.');
  }

  function updateNotionStatus(connected, title) {
    var chip = document.getElementById('notionStatusChip');
    if (connected) {
      chip.className = 'notion-status-chip connected';
      chip.textContent = title ? ('üìÑ ' + title.slice(0, 20)) : 'Connected';
    } else {
      chip.className = 'notion-status-chip disconnected';
      chip.textContent = 'Not Connected';
    }
  }

  // ‚îÄ‚îÄ‚îÄ LAYER RENAME TOOLS ‚îÄ‚îÄ‚îÄ
  function renameLayers(type) {
    var btnMap = { 'from-content': 'renameContentBtn', 'clean': 'renameCleanBtn', 'by-type': 'renameTypeBtn', 'number': 'renameNumBtn' };
    var btnId = btnMap[type];
    if (btnId) { var b = document.getElementById(btnId); if (b) b.disabled = true; }
    var status = document.getElementById('renameStatus');
    if (status) { status.style.display = 'block'; status.innerHTML = '<span style="color:#6b7280">Renaming‚Ä¶</span>'; }
    parent.postMessage({ pluginMessage: { type: 'rename-layers', renameType: type } }, '*');
  }

  // ‚îÄ‚îÄ‚îÄ INITIALIZE ‚îÄ‚îÄ‚îÄ
  parent.postMessage({ pluginMessage: { type: 'load-projects' } }, '*');
  connectToBridge();

  // ‚îÄ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      var tabName = tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
      document.getElementById(tabName + '-content').classList.add('active');
    });
  });

  // ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    var keys = { '1': 'projects', '2': 'fixes', '3': 'goals', '4': 'settings' };
    if (keys[e.key]) {
      document.querySelector('[data-tab="' + keys[e.key] + '"]').click();
    }
  });

  // ‚îÄ‚îÄ‚îÄ COPY PROMPT TEMPLATE ‚îÄ‚îÄ‚îÄ
  function copyPrompt() {
    var textarea = document.getElementById('promptTemplate');
    textarea.select();
    document.execCommand('copy');
    var originalBg = textarea.style.background;
    textarea.style.background = '#1a4a1a';
    setTimeout(function() { textarea.style.background = originalBg; }, 200);
  }

  // ‚îÄ‚îÄ‚îÄ OPEN/CLOSE ADD PROJECT SHEET ‚îÄ‚îÄ‚îÄ
  function openAddProject() {
    document.getElementById('addProjectSheet').classList.add('open');
  }

  function closeAddProject() {
    document.getElementById('addProjectSheet').classList.remove('open');
  }

  // ‚îÄ‚îÄ‚îÄ SEND SELECTION TO CLAUDE ‚îÄ‚îÄ‚îÄ
  function sendToClaude(mode) {
    if (!bridgeConnected) {
      alert('‚ö†Ô∏è Bridge server not connected!\n\nStart SidebotBridge.app first.');
      return;
    }
    parent.postMessage({ pluginMessage: { type: 'send-to-claude', mode: mode } }, '*');
  }

  // ‚îÄ‚îÄ‚îÄ IMPORT JSON ‚îÄ‚îÄ‚îÄ
  function importJSON() {
    var jsonText = document.getElementById('jsonInput').value.trim();

    if (!jsonText) { alert('Please paste JSON from Claude!'); return; }

    try {
      var data = JSON.parse(jsonText);

      if (!data.projectName || !data.goals || !Array.isArray(data.goals)) {
        alert('Invalid JSON. Need: {"projectName": "...", "goals": [...]}');
        return;
      }

      if (data.goals.length === 0) { alert('No goals found!'); return; }

      var existing = allProjects.find(function(p) { return p.name === data.projectName; });

      if (existing) {
        if (confirm('Project "' + data.projectName + '" exists. Replace goals with ' + data.goals.length + ' new ones?')) {
          parent.postMessage({
            pluginMessage: {
              type: 'add-goals', projectId: existing.id, goals: data.goals, prdText: data.prdText || ''
            }
          }, '*');
          document.getElementById('jsonInput').value = '';
          selectProject(existing.id);
          setTimeout(function() { document.querySelector('[data-tab="goals"]').click(); }, 100);
        }
      } else {
        parent.postMessage({ pluginMessage: { type: 'create-project', name: data.projectName } }, '*');
        window.pendingGoals = { goals: data.goals, prdText: data.prdText || '' };
        document.getElementById('jsonInput').value = '';
      }
    } catch (e) {
      alert('Invalid JSON: ' + e.message);
    }
  }

  // ‚îÄ‚îÄ‚îÄ DELETE PROJECT ‚îÄ‚îÄ‚îÄ
  function deleteProject(projectId, event) {
    event.stopPropagation();
    if (!confirm('Delete this project?')) return;
    parent.postMessage({ pluginMessage: { type: 'delete-project', projectId: projectId } }, '*');
  }

  // ‚îÄ‚îÄ‚îÄ SELECT PROJECT ‚îÄ‚îÄ‚îÄ
  function selectProject(projectId) {
    parent.postMessage({ pluginMessage: { type: 'set-active-project', projectId: projectId } }, '*');
  }

  // ‚îÄ‚îÄ‚îÄ TOGGLE GOAL ‚îÄ‚îÄ‚îÄ
  function toggleGoal(goalId) {
    if (!currentProject) return;
    parent.postMessage({ pluginMessage: { type: 'toggle-goal', projectId: currentProject.id, goalId: goalId } }, '*');
  }

  // ‚îÄ‚îÄ‚îÄ MARK FIX DONE ‚îÄ‚îÄ‚îÄ
  function markFixDone(fixId) {
    if (!currentProject) return;
    parent.postMessage({ pluginMessage: { type: 'mark-fix-done', projectId: currentProject.id, fixId: fixId } }, '*');
  }

  // ‚îÄ‚îÄ‚îÄ RENDER PROJECTS ‚îÄ‚îÄ‚îÄ
  function renderProjects(projects, activeProject) {
    var list = document.getElementById('projectList');

    if (projects.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div><div class="empty-text">No projects yet.<br>Create your first one below!</div></div>';
      return;
    }

    list.innerHTML = projects.map(function(p) {
      return '<div class="project-item ' + (p.id === (activeProject && activeProject.id) ? 'active' : '') + '" onclick="selectProject(\'' + p.id + '\')">' +
        '<div class="project-name">' + escHtml(p.name) + '</div>' +
        '<div class="project-stats">' +
          '<span>' + (p.goals ? p.goals.length : 0) + ' goals</span>' +
          '<span>' + (p.fixes ? p.fixes.length : 0) + ' fixes</span>' +
        '</div>' +
        '<button class="project-delete" onclick="deleteProject(\'' + p.id + '\', event)">Delete</button>' +
      '</div>';
    }).join('');
  }

  // ‚îÄ‚îÄ‚îÄ CONFETTI ANIMATION ‚îÄ‚îÄ‚îÄ
  function triggerConfetti() {
    var colors = ['purple', 'yellow', 'blue', 'green', 'pink'];
    var confettiCount = 50;
    for (var i = 0; i < confettiCount; i++) {
      (function(idx) {
        setTimeout(function() {
          var confetti = document.createElement('div');
          confetti.className = 'confetti confetti-' + colors[Math.floor(Math.random() * colors.length)];
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.animation = 'confetti-fall ' + (2 + Math.random() * 2) + 's linear';
          document.body.appendChild(confetti);
          setTimeout(function() { confetti.remove(); }, 4000);
        }, idx * 30);
      })(i);
    }
  }

  // ‚îÄ‚îÄ‚îÄ ACTION BUTTON FUNCTIONS ‚îÄ‚îÄ‚îÄ
  function checkGrammar() {
    parent.postMessage({ pluginMessage: { type: 'send-to-claude', mode: 'selection', action: 'grammar' } }, '*');
    alert('üìã Copy the data below and paste in Claude Desktop:\n\n"Check grammar and spelling in my selected design"');
  }

  function checkAutoLayout() {
    parent.postMessage({ pluginMessage: { type: 'send-to-claude', mode: 'selection', action: 'autolayout' } }, '*');
    alert('üìã Copy the data below and paste in Claude Desktop:\n\n"Check auto-layout setup and suggest improvements"');
  }

  function checkContrast() {
    parent.postMessage({ pluginMessage: { type: 'send-to-claude', mode: 'selection', action: 'contrast' } }, '*');
    alert('üìã Copy the data below and paste in Claude Desktop:\n\n"Check color contrast ratios for accessibility (WCAG AA)"');
  }

  function generalReview() {
    parent.postMessage({ pluginMessage: { type: 'send-to-claude', mode: 'selection', action: 'review' } }, '*');
    alert('üìã Copy the data below and paste in Claude Desktop:\n\n"Review my design against the PRD requirements"');
  }

  // ‚îÄ‚îÄ‚îÄ RENDER GOALS ‚îÄ‚îÄ‚îÄ
  function renderGoals(project) {
    var list = document.getElementById('goalList');
    var empty = document.getElementById('goalsEmpty');
    var title = document.getElementById('goalsTitle');
    var progress = document.getElementById('goalsProgress');
    var fill = document.getElementById('progressFill');

    if (!project) {
      title.textContent = 'No project selected';
      progress.textContent = '0/0 complete (0%)';
      fill.style.width = '0%';
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    title.textContent = project.name;

    if (!project.goals || project.goals.length === 0) {
      progress.textContent = '0/0 complete (0%)';
      fill.style.width = '0%';
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';

    var doneCount = project.goals.filter(function(g) { return g.status === 'done'; }).length;
    var total = project.goals.length;
    var percent = Math.round((doneCount / total) * 100);

    progress.textContent = doneCount + '/' + total + ' complete (' + percent + '%)';
    fill.style.width = percent + '%';

    if (percent === 100 && doneCount > 0) setTimeout(triggerConfetti, 300);

    list.innerHTML = project.goals.map(function(g) {
      return '<div class="goal-item ' + (g.status === 'done' ? 'done' : '') + '" onclick="toggleGoal(\'' + g.id + '\')">' +
        '<div class="goal-checkbox"></div>' +
        '<div class="goal-text">' + escHtml(g.text) + '</div>' +
      '</div>';
    }).join('');
  }

  // ‚îÄ‚îÄ‚îÄ RENDER FIXES ‚îÄ‚îÄ‚îÄ
  function renderFixes(project) {
    var list = document.getElementById('fixList');
    var empty = document.getElementById('fixesEmpty');

    if (!project || !project.fixes || project.fixes.length === 0) {
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';

    list.innerHTML = project.fixes.map(function(f) {
      return '<div class="fix-item ' + (f.status === 'done' ? 'done' : '') + '">' +
        '<div class="fix-header">' +
          '<div class="fix-title">' + (f.status === 'done' ? '‚úÖ' : '‚ö†Ô∏è') + ' ' + (f.issue || 'Issue') + '</div>' +
        '</div>' +
        '<div class="fix-description">' + (f.description || f.suggestion || 'No details') + '</div>' +
        '<div class="fix-actions">' +
          '<button class="fix-btn done-btn" onclick="markFixDone(\'' + f.id + '\')" ' + (f.status === 'done' ? 'disabled' : '') + '>' +
            (f.status === 'done' ? 'Done ‚úì' : 'Mark as Fixed') +
          '</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  // ‚îÄ‚îÄ‚îÄ UPDATE HEADER ‚îÄ‚îÄ‚îÄ
  function updateHeader(project) {
    var header = document.getElementById('headerProject');
    if (!project) {
      header.textContent = 'No project selected';
      header.classList.add('empty');
    } else {
      header.textContent = project.name;
      header.classList.remove('empty');
    }
  }

  // ‚îÄ‚îÄ‚îÄ ESCAPE HTML ‚îÄ‚îÄ‚îÄ
  function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ‚îÄ‚îÄ‚îÄ MESSAGE HANDLER ‚îÄ‚îÄ‚îÄ
  window.onmessage = function(event) {
    var msg = event.data.pluginMessage;
    if (!msg) return;

    console.log('üì® UI received:', msg.type);

    if (msg.type === 'projects-loaded' || msg.type === 'init-complete') {
      allProjects = msg.projects || [];
      currentProject = msg.activeProject;
      if (msg.notionToken) { notionToken = msg.notionToken; updateNotionStatus(true, null); }
      renderProjects(allProjects, currentProject);
      renderGoals(currentProject);
      renderFixes(currentProject);
      updateHeader(currentProject);
    }

    if (msg.type === 'project-created') {
      allProjects = msg.allProjects;
      currentProject = msg.project;
      renderProjects(allProjects, currentProject);
      updateHeader(currentProject);
      closeAddProject();

      if (window.pendingGoals) {
        parent.postMessage({
          pluginMessage: {
            type: 'add-goals', projectId: currentProject.id,
            goals: window.pendingGoals.goals, prdText: window.pendingGoals.prdText
          }
        }, '*');
        window.pendingGoals = null;
        setTimeout(function() { document.querySelector('[data-tab="goals"]').click(); }, 100);
      }
    }

    if (msg.type === 'project-deleted') {
      allProjects = msg.allProjects;
      currentProject = allProjects[0] || null;
      renderProjects(allProjects, currentProject);
      renderGoals(currentProject);
      renderFixes(currentProject);
      updateHeader(currentProject);
    }

    if (msg.type === 'active-project-changed') {
      currentProject = msg.project;
      renderProjects(allProjects, currentProject);
      renderGoals(currentProject);
      renderFixes(currentProject);
      updateHeader(currentProject);
    }

    if (msg.type === 'goals-updated') {
      var idx = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
      if (idx !== -1) allProjects[idx] = msg.project;
      if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
      renderGoals(currentProject);
      renderProjects(allProjects, currentProject);
    }

    if (msg.type === 'goal-toggled') {
      var idx2 = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
      if (idx2 !== -1) allProjects[idx2] = msg.project;
      if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
      renderGoals(currentProject);
    }

    if (msg.type === 'fixes-updated') {
      var idx3 = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
      if (idx3 !== -1) allProjects[idx3] = msg.project;
      if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
      renderFixes(currentProject);
      renderProjects(allProjects, currentProject);
    }

    if (msg.type === 'fix-marked-done') {
      var idx4 = allProjects.findIndex(function(p) { return p.id === msg.project.id; });
      if (idx4 !== -1) allProjects[idx4] = msg.project;
      if (currentProject && currentProject.id === msg.project.id) currentProject = msg.project;
      renderFixes(currentProject);
    }

    if (msg.type === 'error') {
      console.error('Plugin error:', msg.message);
    }

    if (msg.type === 'notion-token-saved') {
      updateNotionStatus(true, null);
    }

    if (msg.type === 'claude-data-ready') {
      if (bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
        bridgeSocket.send(JSON.stringify({
          type: 'design-data',
          data: {
            mode: msg.mode, pageName: msg.pageName, fileKey: msg.fileKey,
            nodes: msg.data,
            projectName: currentProject ? currentProject.name : 'Unknown'
          }
        }));
        alert('üì§ Design sent to Claude!\n\nNow tell Claude:\n"Review my design against the PRD"');
      } else {
        alert('‚ö†Ô∏è Bridge not connected!\n\nStart SidebotBridge.app first.');
      }
    }

    if (msg.type === 'state-for-bridge') {
      if (bridgeSocket && bridgeSocket.readyState === WebSocket.OPEN) {
        bridgeSocket.send(JSON.stringify({
          type: 'state-update', projects: msg.projects, activeProject: msg.activeProject
        }));
      }
    }

    if (msg.type === 'bridge-status') {
      updateConnectionIndicator(msg.connected);
    }

    if (msg.type === 'rename-done') {
      ['renameContentBtn','renameCleanBtn','renameTypeBtn','renameNumBtn'].forEach(function(id) {
        var b = document.getElementById(id); if (b) b.disabled = false;
      });
      var status = document.getElementById('renameStatus');
      if (!status) return;
      var html = '';
      if (msg.count > 0) {
        html = '<div style="color:#4ade80;font-weight:600;">‚úì Renamed ' + msg.count + ' layer' + (msg.count !== 1 ? 's' : '') + '</div>';
        (msg.renamedList || []).forEach(function(r) {
          html += '<div style="font-size:9px;margin-top:2px;font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' +
            '<span style="color:#ff6b6b">' + escHtml(r.from) + '</span>' +
            '<span style="color:#6b7280"> ‚Üí </span>' +
            '<span style="color:#4ade80">' + escHtml(r.to) + '</span>' +
          '</div>';
        });
        if ((msg.renamedList || []).length < msg.count) {
          html += '<div style="color:#6b7280;font-size:9px;">‚Ä¶and ' + (msg.count - msg.renamedList.length) + ' more</div>';
        }
      } else {
        html = '<div style="color:#6b7280;">' + (msg.error ? '‚ö†Ô∏è ' + escHtml(msg.error) : '‚ö†Ô∏è No changes ‚Äî names already match') + '</div>';
      }
      status.style.display = 'block';
      status.innerHTML = html;
      setTimeout(function() { status.style.display = 'none'; status.innerHTML = ''; }, 6000);
    }
  };
</script>

</body>
</html>
